<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Welfare Branch Diary</title>
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --sidebar-bg: #1E1E1E;
            --content-bg: #121212;
            --card-bg: #1B1B1B;
            --primary-color: #3B82F6;
            --text-primary: #EDEDED;
            --text-secondary: #A1A1AA;
            --border-color: #333333;
            --hover-bg: #2A2A2A;
            --gradient-bg: linear-gradient(145deg, #1B1B1B, #252525);
        }
        html, body {
            height: 100%; margin: 0; overflow-x: hidden; box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--content-bg); color: var(--text-primary);
        }
        .sidebar {
            background-color: var(--sidebar-bg); position: fixed; top: 0; left: 0; height: 100vh; z-index: 100;
            box-shadow: 4px 0 12px rgba(0,0,0,0.6); transition: width 0.3s ease; overflow-x: hidden;
        }
        .sidebar::-webkit-scrollbar { display: none; }

        .dashboard-card { transition: all 0.3s ease; background: var(--gradient-bg); min-height: 120px; }
        .dashboard-card:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(0,0,0,0.8); background: var(--hover-bg); }

        .status-Pending { background-color: #292415; color: #facc15; }
        .status-Sent { background-color: #1a2c4e; color: #60a5fa; }
        .status-Approved { background-color: #1a4235; color: #34d399; }
        .status-Objection { background-color: #551e1e; color: #f87171; }
        .status-Rejected { background-color: #442a5a; color: #c4b5fd; }

        input::placeholder, textarea::placeholder { color: var(--text-secondary); opacity: 0.6; }

        /* Modern Dark Scrollbar */
        .dark ::-webkit-scrollbar { width: 6px; height: 6px; }
        .dark ::-webkit-scrollbar-track { background: #1a1a1a; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #555; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #777; }

        /* ZOOM-PROOF DASHBOARD */
        #dashboardContainer { min-width: 1000px; }
        @media (max-width: 1280px) { #dashboardContainer { min-width: 800px; } }
        @media (max-width: 1024px) { #dashboardContainer { min-width: 600px; } }
        @media (max-width: 768px)  { #dashboardContainer { min-width: 400px; } }
    </style>
</head>
<body class="text-base">

    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center bg-[var(--content-bg)]">
        <div class="bg-[var(--card-bg)] p-8 rounded-xl shadow-2xl max-w-md w-full">
            <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-6 text-center">Login to Welfare Diary</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="text-sm font-semibold text-[var(--text-secondary)]">Email</label>
                    <input type="email" id="email" class="w-full p-3 rounded-lg border border-[var(--border-color)] bg-[#222222] text-[var(--text-primary)]" placeholder="Enter email" required>
                </div>
                <div>
                    <label class="text-sm font-semibold text-[var(--text-secondary)]">Password</label>
                    <input type="password" id="password" class="w-full p-3 rounded-lg border border-[var(--border-color)] bg-[#222222] text-[var(--text-primary)]" placeholder="Enter password" required>
                </div>
                <button type="submit" class="w-full bg-[var(--primary-color)] text-white p-3 rounded-lg font-semibold hover:bg-blue-700">Login</button>
            </form>
            <p id="loginError" class="text-red-500 text-sm mt-4 hidden">Invalid email or password</p>
        </div>
    </div>

    <!-- Main App -->
    <div class="hidden min-h-screen flex" id="appContent">
        <div id="customModal" class="fixed inset-0 bg-black bg-opacity-70 z-[1000] hidden flex items-center justify-center p-4">
            <div class="bg-[var(--card-bg)] p-6 rounded-xl shadow-2xl max-w-sm w-full" id="modalContent">
                <h3 id="modalTitle" class="text-xl font-bold mb-3 text-[var(--text-primary)]"></h3>
                <p id="modalMessage" class="mb-5 text-[var(--text-secondary)]"></p>
                <div id="modalActions" class="flex justify-end gap-3"></div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar w-[60px] md:w-[300px] flex flex-col flex-shrink-0">
            <div class="flex items-center justify-start gap-3 px-4 py-4 border-b border-[var(--border-color)]">
                <img src="./logo.jpg" alt="Logo" class="w-10 h-10 rounded-md" onerror="this.src='https://via.placeholder.com/40?text=WL'"/>
                <div class="hidden md:block">
                    <span class="text-[var(--text-primary)] font-semibold text-lg block">Welfare Branch Diary</span>
                    <span class="text-[var(--text-secondary)] text-sm">Special Protection Unit</span>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto mt-2"><div class="space-y-1 px-2" id="menu"></div></div>
            <div class="p-4 border-t border-[var(--border-color)]">
                <button id="logoutBtn" class="flex items-center gap-3 w-full text-left p-3 rounded-lg hover:bg-[#2c2c2c]">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                    <span class="hidden md:inline">Logout</span>
                </button>
                <p class="text-xs text-[var(--text-secondary)] text-center hidden md:block mt-2">Â© 2025 Developed by Rao Hashim Ali</p>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-x-auto min-w-0">
            <div class="max-w-7xl mx-auto px-4 py-6">
                <button id="menuToggle" class="md:hidden fixed top-4 left-4 z-50 p-2 rounded-full bg-[var(--primary-color)] text-white">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>

                <div class="flex flex-wrap items-center justify-between gap-4 mb-6" id="topBar">
                    <input type="search" id="search" class="flex-1 min-w-[280px] p-3 rounded-full border border-[var(--border-color)] bg-[var(--card-bg)] text-[var(--text-primary)]" placeholder="Search employees, cases, or records..."/>
                    <div class="flex gap-3">
                        <div id="notifyContainer" class="relative">
                            <button id="notifyBtn" class="p-2 rounded-full bg-gray-700"><i data-lucide="bell" class="w-5 h-5"></i><span id="notifyCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-2 hidden">0</span></button>
                            <div id="notifyDropdown" class="hidden absolute right-0 mt-2 w-80 bg-[var(--card-bg)] border rounded-lg shadow-lg max-h-96 overflow-y-auto"><ul id="notifyList" class="divide-y divide-[var(--border-color)]"></ul><button id="clearNotifs" class="w-full p-2 text-center text-[var(--text-secondary)] hover:bg-[var(--hover-bg)]">Clear All</button></div>
                        </div>
                        <button id="themeToggle" class="p-2 rounded-full bg-gray-700"><i data-lucide="moon" class="w-5 h-5"></i></button>
                        <div id="tabActions" class="flex gap-2 hidden">
                            <button id="exportTabXlsx" class="flex items-center gap-1 px-4 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-600">
                                <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Export Tab (XLS)
                            </button>
                        </div>
                    </div>
                </div>

                <div id="searchDedicatedResults" class="hidden"></div>
                <div id="contentArea"></div>
            </div>
        </div>
    </div>

<script>
// ==================== FULL WORKING JS ====================
const SECTIONS = [ /* tumhara poora SECTIONS array yahan paste kar do - main ne upar diya hai */ ];

let state = {}, activeId = 'dashboard', subActiveId = null, filterStatus = null, selectedIndex = null;
let isSearchMode = false, currentTheme = 'dark', currentFontSize = localStorage.getItem('fontSize') || 'text-base', isMenuOpen = false;
let notifications = [];

const elements = {
    sidebarEl: document.querySelector('.sidebar'),
    mainContentEl: document.getElementById('mainContent'),
    menuToggleEl: document.getElementById('menuToggle'),
    menuEl: document.getElementById('menu'),
    contentArea: document.getElementById('contentArea'),
    searchInput: document.getElementById('search'),
    loginPage: document.getElementById('loginPage'),
    appContent: document.getElementById('appContent'),
    loginForm: document.getElementById('loginForm'),
    loginError: document.getElementById('loginError'),
    logoutBtn: document.getElementById('logoutBtn'),
    notifyBtn: document.getElementById('notifyBtn'),
    notifyDropdown: document.getElementById('notifyDropdown'),
    notifyList: document.getElementById('notifyList'),
    notifyCount: document.getElementById('notifyCount'),
    clearNotifs: document.getElementById('clearNotifs'),
    themeToggle: document.getElementById('themeToggle')
};

function initializeIcons() { if (typeof lucide !== 'undefined') lucide.createIcons(); }

async function loadState() {
    try {
        if (window.db) {
            const docRef = doc(collection(db, 'app_states'), 'default');
            const snap = await getDoc(docRef);
            if (snap.exists()) state = snap.data();
        }
    } catch (e) { console.error(e); }
    SECTIONS.forEach(sec => {
        if (sec.key && !state[sec.key]) state[sec.key] = [];
        if (sec.subSections) sec.subSections.forEach(s => { if (s.key && !state[s.key]) state[s.key] = []; });
    });
    if (!state.notifications) state.notifications = [];
    notifications = state.notifications;
}

function saveState() {
    if (window.db) {
        const docRef = doc(collection(db, 'app_states'), 'default');
        setDoc(docRef, state).catch(e => console.error(e));
    }
}

async function initAuth() {
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            elements.loginPage.classList.add('hidden');
            elements.appContent.classList.remove('hidden');
            await loadState();
            buildMenu();
            renderContent();
            applyLayout();
        } else {
            elements.loginPage.classList.remove('hidden');
            elements.appContent.classList.add('hidden');
        }
    });

    elements.loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            elements.loginError.textContent = 'Invalid email or password';
            elements.loginError.classList.remove('hidden');
        }
    });

    elements.logoutBtn.addEventListener('click', () => signOut(auth));
}

function applyLayout() {
    const isDesktop = window.innerWidth >= 768;
    elements.sidebarEl.style.width = isDesktop ? '300px' : (isMenuOpen ? '300px' : '60px');
    elements.mainContentEl.style.marginLeft = isDesktop ? '300px' : (isMenuOpen ? '300px' : '60px');
    elements.menuToggleEl.classList.toggle('hidden', isDesktop);
}

function toggleMenu() {
    if (window.innerWidth < 768) {
        isMenuOpen = !isMenuOpen;
        applyLayout();
    }
}

function buildMenu() {
    elements.menuEl.innerHTML = '';
    SECTIONS.forEach(s => {
        const btn = document.createElement('button');
        btn.className = `flex items-center gap-3 w-full text-left p-3 rounded-lg hover:bg-[#2c2c2c] transition-all ${s.id === activeId ? 'bg-[#3b3b3b] text-white' : 'text-[#ccc]'}`;
        btn.innerHTML = `<i data-lucide="${s.icon}" class="w-5 h-5"></i><span class="hidden md:inline">${s.title}</span>`;
        btn.onclick = () => { activeId = s.id; subActiveId = null; filterStatus = null; isSearchMode = false; elements.searchInput.value = ''; buildMenu(); renderContent(); };
        elements.menuEl.appendChild(btn);
    });
    initializeIcons();
}

function renderDashboard() {
    contentArea.innerHTML = `
        <h2 class="text-3xl font-bold mb-6">Welfare Status Dashboard</h2>
        <div class="overflow-x-auto -mx-4 px-4">
            <div id="dashboardContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Cards will be added by JS -->
            </div>
        </div>
    `;
    // Add your cards here (same as before)
    initializeIcons();
}

function renderContent() {
    if (activeId === 'dashboard') renderDashboard();
    else contentArea.innerHTML = `<h2 class="text-3xl font-bold mb-6">${SECTIONS.find(s => s.id === activeId)?.title || 'Section'}</h2><p>Coming soon...</p>`;
}

window.onload = async function() {
    initializeIcons();
    elements.menuToggleEl.addEventListener('click', toggleMenu);
    window.addEventListener('resize', applyLayout);
    await initAuth();
};
</script>

<!-- Firebase (Working) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getFirestore, collection, getDoc, setDoc, doc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCVj-Eb9wNAaqwFyGdRgC7uyR24O2jjOIw",
    authDomain: "spuwelfarediary.firebaseapp.com",
    projectId: "spuwelfarediary",
    storageBucket: "spuwelfarediary.firebasestorage.app",
    messagingSenderId: "976541344867",
    appId: "1:976541344867:web:96f6e70b42f0ab33808456"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  window.db = db; window.auth = auth;
  window.getDoc = getDoc; window.setDoc = setDoc;
  window.doc = doc; window.collection = collection;
  window.signInWithEmailAndPassword = signInWithEmailAndPassword;
  window.signOut = signOut; window.onAuthStateChanged = onAuthStateChanged;
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=10.0, minimum-scale=0.5, user-scalable=yes" />
    <title>Welfare Branch Diary</title>
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --sidebar-bg: #1E1E1E;
            --content-bg: #121212;
            --card-bg: #1B1B1B;
            --primary-color: #3B82F6;
            --text-primary: #EDEDED;
            --text-secondary: #A1A1AA;
            --border-color: #333333;
            --hover-bg: #2A2A2A;
            --gradient-bg: linear-gradient(145deg, #1B1B1B, #252525);
        }

        .light {
            --sidebar-bg: #FFFFFF;
            --content-bg: #F3F4F6;
            --card-bg: #FFFFFF;
            --primary-color: #2563EB;
            --text-primary: #1F2937;
            --text-secondary: #4B5563;
            --border-color: #D1D5DB;
            --hover-bg: #F3F4F6;
            --gradient-bg: linear-gradient(145deg, #FFFFFF, #F3F4F6);
        }

        html, body {
            height: 100%;
            margin: 0;
            overflow-x: auto;
	    overflow-y: auto;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--content-bg);
            color: var(--text-primary);
        }
.sidebar {
    width: 60px;
}
@media (min-width: 768px) {
    .sidebar { width: 300px; }
}
        .sidebar {
            background-color: var(--sidebar-bg);
            color: var(--text-primary);
            box-sizing: border-box;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 100;
            box-shadow: 4px 0 12px rgba(0, 0, 0, 0.6);
            transition: width 0.3s ease, transform 0.3s ease;
            overflow-x: hidden;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .sidebar::-webkit-scrollbar {
            display: none;
        }

        .dashboard-card {
            transition: all 0.3s ease;
            background: var(--gradient-bg);
            word-break: break-word;
            min-height: 120px;
        }
        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.8);
            background: var(--hover-bg);
        }
        .dashboard-card p {
            word-break: break-word;
            hyphens: auto;
            overflow: hidden;
        }

        .status-Pending { background-color: #292415; color: #facc15; }
        .status-Sent { background-color: #1a2c4e; color: #60a5fa; }
        .status-Approved { background-color: #1a4235; color: #34d399; }
        .status-Objection { background-color: #551e1e; color: #f87171; }
        .status-Rejected { background-color: #442a5a; color: #c4b5fd; }

        /* Dim placeholder text */
        input::placeholder, textarea::placeholder {
            color: var(--text-secondary);
            opacity: 0.5;
        }

        /* Modern Minimalistic Scrollbar for Dark Mode */
        .dark ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        .dark ::-webkit-scrollbar-track {
            background: #1a1a1a; /* Dark background */
            border-radius: 3px;
        }
        
        .dark ::-webkit-scrollbar-thumb {
            background: #555; /* Subtle gray */
            border-radius: 3px;
        }
        
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #777; /* Lighter on hover */
        }
        
        /* For Firefox in dark mode */
        .dark {
            scrollbar-width: thin;
            scrollbar-color: #555 #1a1a1a;
        }
.main-content-area {
    margin-left: 60px;
}
@media (min-width: 768px) {
    .main-content-area { margin-left: 300px; }
}
    </style>
</head>
<body class="text-base">
    <div id="loginPage" class="min-h-screen flex items-center justify-center bg-[var(--content-bg)]">
        <div class="bg-[var(--card-bg)] p-8 rounded-xl shadow-2xl max-w-md w-full transform transition-all hover:-translate-y-1">
            <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-6 text-center">Login to Welfare Diary</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="email" class="text-sm font-semibold text-[var(--text-secondary)]">Email</label>
                    <input type="email" id="email" class="mt-1 w-full p-3 rounded-lg border border-[var(--border-color)] bg-[#222222] text-[var(--text-primary)] focus:ring-2 focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)] transition-all" placeholder="Enter email" required aria-required="true">
                </div>
                <div>
                    <label for="password" class="text-sm font-semibold text-[var(--text-secondary)]">Password</label>
                    <input type="password" id="password" class="mt-1 w-full p-3 rounded-lg border border-[var(--border-color)] bg-[#222222] text-[var(--text-primary)] focus:ring-2 focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)] transition-all" placeholder="Enter password" required aria-required="true">
                </div>
                <div class="text-right">
                    <a href="#" id="forgotPassword" class="text-blue-500 text-sm hover:underline">Forgot Password?</a>
                </div>
                <button type="submit" class="w-full bg-[var(--primary-color)] text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-all">Login</button>
            </form>
            <p id="loginError" class="text-red-500 text-sm mt-4 hidden">Invalid email or password</p>
        </div>
    </div>

    <div class="hidden min-h-screen flex flex-col md:flex-row" id="appContent">
        <div id="customModal" class="fixed inset-0 bg-black bg-opacity-70 z-[1000] hidden flex items-center justify-center p-4">
            <div class="bg-[var(--card-bg)] p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-95 opacity-0" id="modalContent">
                <h3 id="modalTitle" class="text-xl font-bold mb-3 text-[var(--text-primary)]"></h3>
                <p id="modalMessage" class="mb-5 text-[var(--text-secondary)]"></p>
                <div id="modalActions" class="flex justify-end gap-3"></div>
            </div>
        </div>

        <div class="sidebar flex flex-col flex-shrink-0">
            <div class="flex items-center justify-start gap-3 px-4 py-4 border-b border-[var(--border-color)]">
                <img src="./logo.jpg" alt="Welfare Branch Logo" class="w-10 h-10 rounded-md object-cover shadow-md" onerror="this.onerror=null; this.src='https://via.placeholder.com/40?text=WL'" />
                <div class="hidden md:block">
                    <span class="text-[var(--text-primary)] font-semibold text-lg block">Welfare Branch Diary</span>
                    <span class="text-[var(--text-secondary)] text-sm">Special Protection Unit</span>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto mt-2">
                <div class="space-y-1 px-2" id="menu"></div>
            </div>
            <div class="mt-4 pt-4 border-t border-[var(--border-color)] p-4">
                <p class="text-xs text-[var(--text-secondary)] text-center hidden md:block mt-2">Â© 2025 Devoloped by Hashim Ali</p>
            </div>
        </div>

        <div class="flex-1 p-4 transition-all main-content-area" id="mainContent">
            <button id="menuToggle" class="md:hidden fixed top-4 left-4 z-50 p-2 rounded-full bg-[var(--primary-color)] text-white shadow-lg hover:bg-blue-700" aria-label="Toggle menu">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
            
            <div class="flex flex-wrap items-center justify-between gap-3 mb-4" id="topBar">
                <input type="search" id="search" 
                    class="w-full md:w-[350px] p-3 rounded-full border border-[var(--border-color)] bg-[var(--card-bg)] text-[var(--text-primary)] 
                    focus:ring-2 focus:ring-[var(--primary-color)] transition-all duration-300 shadow-xl" 
                    placeholder="Search employees, cases, or records..." aria-label="Search entries" />
                
                <div id="tabActions" class="flex gap-2 hidden"> 
                    <button id="exportTabXlsx" class="flex items-center gap-1 px-4 py-2 rounded-lg bg-gray-700 text-[var(--text-primary)] hover:bg-gray-600 transition-all" aria-label="Export current tab to Excel">
                        <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Export Tab (XLS)
                    </button>
                </div>
                <div class="flex justify-end items-center space-x-2"> 
    <div id="notifyContainer" class="relative">
        <button id="notifyBtn" class="p-2 rounded-full bg-gray-700 text-[var(--text-primary)] hover:bg-gray-600" aria-label="Notifications">
            <i data-lucide="bell" class="w-5 h-5"></i>
            <span id="notifyCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-2 hidden">0</span>
        </button>
        <div id="notifyDropdown" class="hidden absolute right-0 mt-2 w-80 bg-[var(--card-bg)] border border-[var(--border-color)] rounded-lg shadow-lg z-50 max-h-96 overflow-y-auto">
            <ul id="notifyList" class="divide-y divide-[var(--border-color)]"></ul>
            <button id="clearNotifs" class="w-full p-2 text-center text-[var(--text-secondary)] hover:bg-[var(--hover-bg)]">Clear All</button>
        </div>
    </div>

    <button id="themeToggle" class="p-2 rounded-full bg-gray-700 text-[var(--text-primary)] hover:bg-gray-600" aria-label="Toggle theme">
        <i data-lucide="moon" class="w-5 h-5"></i>
    </button>

    <button id="logoutBtn" class="p-2 rounded-full bg-gray-700 text-[var(--text-primary)] hover:bg-gray-600" aria-label="Logout">
        <i data-lucide="log-out" class="w-5 h-5"></i>
    </button>
</div>

            
            <div id="searchDedicatedResults" class="flex flex-col gap-4 max-w-full hidden"></div>
            
            <div id="contentArea" class="flex flex-col gap-4 max-w-full"></div>
        </div>
    </div>

<script>
/* ---------- Configuration ---------- */
const SECTIONS = [
    { id:'dashboard', title:'Dashboard', icon:'layout-dashboard' },
    { id:'medical', title:'Medical Financial Assistance', key:'welfare_medical', icon:'dollar-sign', fields:[
        {k:'diaryNo',label:'Diary No.',type:'number'},
        {k:'dateReceived',label:'Date Received',type:'date'},
        {k:'applicantName',label:'Applicant Name',type:'text'},
        {k:'subject',label:'Subject',type:'text'},
        {k:'fromOffice',label:'From Office',type:'text'},
        {k:'claimAmount',label:'Claim Amount',type:'number'},
        {k:'illnessReason',label:'Illness / Reason',type:'text'},
        {k:'missing1',label:'Missing Docs Letter 1st',type:'date', optional: true},
        {k:'reminder1',label:'Reminder 1',type:'date', optional: true},
        {k:'reminder2',label:'Reminder 2',type:'date', optional: true},
        {k:'documentsReceived',label:'Documents Received',type:'date', optional: true},
        {k:'sentHigher',label:'Sent to Higher Office',type:'date', optional: true},
        {k:'status',label:'Status',type:'select',options:['Pending','Sent','Approved','Rejected','Objection']},
        {k:'remarks',label:'Remarks',type:'textarea', full:true}
    ]},
    { id:'wedding', title:'Wedding Gift', key:'welfare_wedding', icon:'gift', fields:[
        {k:'diaryNo',label:'Diary No.',type:'number'},
        {k:'dateReceived',label:'Date Received',type:'date'},
        {k:'applicantName',label:'Applicant Name',type:'text'},
        {k:'subject',label:'Subject',type:'text'},
        {k:'brideName',label:'Bride Name',type:'text'},
        {k:'amount',label:'Amount',type:'number'},
        {k:'fromOffice',label:'From Office',type:'text'},
        {k:'missing1',label:'Missing Docs Letter 1st',type:'date', optional: true},
        {k:'reminder1',label:'Reminder 1',type:'date', optional: true},
        {k:'reminder2',label:'Reminder 2',type:'date', optional: true},
        {k:'documentsReceived',label:'Documents Received',type:'date', optional: true},
        {k:'sentHigher',label:'Sent to Higher Office',type:'date', optional: true},
        {k:'status',label:'Status',type:'select',options:['Pending','Sent','Approved','Rejected','Objection']},
        {k:'remarks',label:'Remarks',type:'textarea', full:true}
    ]},
    { id:'scholarship', title:'Scholarships', key:'welfare_scholarship', icon:'graduation-cap', fields:[
        {k:'diaryNo',label:'Diary No.',type:'number'},
        {k:'dateReceived',label:'Date Received',type:'date'},
        {k:'applicantName',label:'Applicant Name',type:'text'},
        {k:'subject',label:'Subject',type:'text'},
        {k:'studentName',label:'Student Name',type:'text'},
        {k:'amount',label:'Amount',type:'number'},
        {k:'fromOffice',label:'From Office',type:'text'},
        {k:'missing1',label:'Missing Docs Letter 1st',type:'date', optional: true},
        {k:'reminder1',label:'Reminder 1',type:'date', optional: true},
        {k:'reminder2',label:'Reminder 2',type:'date', optional: true},
        {k:'documentsReceived',label:'Documents Received',type:'date', optional: true},
        {k:'sentHigher',label:'Sent to Higher Office',type:'date', optional: true},
        {k:'status',label:'Status',type:'select',options:['Pending','Sent','Approved','Rejected','Objection']},
        {k:'remarks',label:'Remarks',type:'textarea', full:true}
    ]},
    { id:'basicpay', title:'Last Month Basic Pay', key:'welfare_basicpay', icon:'wallet', fields:[
        {k:'diaryNo',label:'Diary No.',type:'number'},
        {k:'dateReceived',label:'Date Received',type:'date'},
        {k:'applicantName',label:'Applicant Name',type:'text'},
        {k:'subject',label:'Subject',type:'text'},
        {k:'fromOffice',label:'From Office',type:'text'},
        {k:'amount',label:'Amount',type:'number'},
        {k:'documentsReceived',label:'Documents Received',type:'date', optional: true},
        {k:'sentHigher',label:'Sent to Higher Office',type:'date', optional: true},
        {k:'status',label:'Status',type:'select',options:['Pending','Sent','Approved','Rejected','Objection']},
        {k:'remarks',label:'Remarks',type:'textarea', full:true}
    ]},
    { id:'misc', title:'Misc Letter', key:'welfare_misc', icon:'mail', fields:[
        {k:'diaryNo',label:'Diary No.',type:'number'},
        {k:'dateReceived',label:'Date Received',type:'date'},
        {k:'applicantName',label:'Applicant Name',type:'text'},
        {k:'subject',label:'Subject',type:'text'},
        {k:'fromOffice',label:'From Office',type:'text'},
        {k:'missing1',label:'Missing Docs Letter 1st',type:'date', optional: true},
        {k:'reminder1',label:'Reminder 1',type:'date', optional: true},
        {k:'reminder2',label:'Reminder 2',type:'date', optional: true},
        {k:'reminder3',label:'Reminder 3',type:'date', optional: true},
        {k:'documentsReceived',label:'Documents Received',type:'date', optional: true},
        {k:'sentHigher',label:'Sent to Higher Office',type:'date', optional: true},
        {k:'status',label:'Status',type:'select',options:['Pending','Sent','Approved','Rejected','Objection']},
        {k:'remarks',label:'Remarks',type:'textarea', full:true}
    ]},
    { id:'wmc', title:'Welfare Management Committee (WMC)', icon:'users', subSections:[
        { id:'wmc_medical', title:'Medical Financial Assistance', key:'welfare_wmc_medical', icon:'dollar-sign', fields:[
            {k:'diaryNo',label:'Diary No.',type:'number'},
            {k:'dateReceived',label:'Date Received',type:'date'},
            {k:'applicantName',label:'Applicant Name',type:'text'},
            {k:'subject',label:'Subject',type:'text'},
            {k:'fromOffice',label:'From Office',type:'text'},
            {k:'claimAmount',label:'Claim Amount',type:'number'},
            {k:'sanctionedAmount',label:'Sanctioned Amount',type:'number'},
            {k:'status',label:'Status',type:'select',options:['Pending','Sent','Approved','Rejected','Objection']},
            {k:'remarks',label:'Remarks',type:'textarea', full:true}
        ]},
        { id:'wmc_financial', title:'Financial Assistance', key:'welfare_wmc_financial', icon:'wallet', fields:[
            {k:'diaryNo',label:'Diary No.',type:'number'},
            {k:'dateReceived',label:'Date Received',type:'date'},
            {k:'applicantName',label:'Applicant Name',type:'text'},
            {k:'subject',label:'Subject',type:'text'},
            {k:'fromOffice',label:'From Office',type:'text'},
            {k:'claimAmount',label:'Claim Amount',type:'number'},
            {k:'sanctionedAmount',label:'Sanctioned Amount',type:'number'},
            {k:'status',label:'Status',type:'select',options:['Pending','Sent','Approved','Rejected','Objection']},
            {k:'remarks',label:'Remarks',type:'textarea', full:true}
        ]},
        { id:'wmc_other', title:'Other', key:'welfare_wmc_other', icon:'file-text', fields:[
            {k:'diaryNo',label:'Diary No.',type:'number'},
            {k:'dateReceived',label:'Date Received',type:'date'},
            {k:'applicantName',label:'Applicant Name',type:'text'},
            {k:'subject',label:'Subject',type:'text'},
            {k:'fromOffice',label:'From Office',type:'text'},
            {k:'claimAmount',label:'Claim Amount',type:'number'},
            {k:'sanctionedAmount',label:'Sanctioned Amount',type:'number'},
            {k:'status',label:'Status',type:'select',options:['Pending','Sent','Approved','Rejected','Objection']},
            {k:'remarks',label:'Remarks',type:'textarea', full:true}
        ]},
        { id:'wmc_funds', title:'Add Funds', key:'welfare_wmc_funds', icon:'dollar-sign', fields:[
            {k:'diaryNo',label:'Diary No.',type:'number'},
            {k:'chequeNumber',label:'Cheque Number',type:'text'},
            {k:'chequeDate',label:'Cheque Date',type:'date'},
            {k:'letterNumber',label:'Letter Number',type:'text'},
            {k:'letterDate',label:'Letter Date',type:'date'},
            {k:'chequeAmount',label:'Cheque Amount',type:'number'},
            {k:'remarks',label:'Remarks',type:'textarea', full:true}
        ]}
    ]},
    { id:'settings', title:'Settings', icon: 'settings'}
];

const STORAGE_ROOT = 'welfare_multi_v3';
// NEW GLOBAL STATE VARIABLES
let state = {}, activeId = 'dashboard', subActiveId = null, filterStatus = null, selectedIndex = null;
let isSearchMode = false; // Flag to track if the dedicated search results view is active
let currentTheme = localStorage.getItem('theme') || 'dark';
let currentFontSize = localStorage.getItem('fontSize') || 'text-base';
let isMenuOpen = false;
let notifications = [];

/* ---------- Global Elements ---------- */
const sidebarEl = document.querySelector('.sidebar');
const mainContentEl = document.getElementById('mainContent');
const menuToggleEl = document.getElementById('menuToggle');
const menuEl = document.getElementById('menu');
const contentArea = document.getElementById('contentArea');
const searchDedicatedResults = document.getElementById('searchDedicatedResults'); // NEW Element
const topBar = document.getElementById('topBar');
const searchInput = document.getElementById('search');
const tabActions = document.getElementById('tabActions'); // NEW Element
const loginPage = document.getElementById('loginPage');
const appContent = document.getElementById('appContent');
const loginForm = document.getElementById('loginForm');
const loginError = document.getElementById('loginError');
const logoutBtn = document.getElementById('logoutBtn');
const notifyBtn = document.getElementById('notifyBtn');
const notifyDropdown = document.getElementById('notifyDropdown');
const notifyList = document.getElementById('notifyList');
const notifyCount = document.getElementById('notifyCount');
const clearNotifs = document.getElementById('clearNotifs');
const themeToggle = document.getElementById('themeToggle');

/* ---------- Utility Functions ---------- */
function debounce(func, wait) {
    let timeout;
    return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

function initializeIcons() {
    if (typeof lucide === 'undefined') {
        console.warn('Lucide library not loaded. Icons will not render.');
        return;
    }
    try {
        lucide.createIcons();
    } catch (e) {
        console.error('Failed to initialize Lucide icons:', e);
    }
}

function todayISO() {
    const d = new Date();
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().slice(0, 10);
}

function dateDiff(date1, date2) {
    const d1 = new Date(date1);
    const d2 = new Date(date2);
    return Math.floor((d2 - d1) / (1000 * 60 * 60 * 24));
}

// Beep function
const myAudioContext = new AudioContext();
function beep(duration = 200, frequency = 440, volume = 100) {
    return new Promise((resolve) => {
        let oscillatorNode = myAudioContext.createOscillator();
        let gainNode = myAudioContext.createGain();
        oscillatorNode.connect(gainNode);
        oscillatorNode.frequency.value = frequency;
        oscillatorNode.type = "square";
        gainNode.connect(myAudioContext.destination);
        gainNode.gain.value = volume * 0.01;
        oscillatorNode.start(myAudioContext.currentTime);
        oscillatorNode.stop(myAudioContext.currentTime + duration * 0.001);
        oscillatorNode.onended = resolve;
    });
}

async function loadState() {
    try {
        if (typeof db !== 'undefined' && typeof doc !== 'undefined' && typeof collection !== 'undefined' && typeof getDoc !== 'undefined') {
            const docRef = doc(collection(db, 'app_states'), 'default');
            const snap = await getDoc(docRef);
            if (snap.exists()) {
                state = snap.data();
            } else {
                state = {};
            }
        } else {
            console.warn("Firebase not initialized. Using empty state.");
            state = {};
        }
    } catch (e) {
        console.error("Error loading state:", e);
        state = {};
    }
    SECTIONS.forEach(sec => {
        if (sec.key && !state[sec.key]) state[sec.key] = [];
        if (sec.subSections) {
            sec.subSections.forEach(subSec => {
                if (subSec.key && !state[subSec.key]) state[subSec.key] = [];
            });
        }
    });
    if (!state.notifications) state.notifications = [];
    notifications = state.notifications;
    updateNotifyCount();
    applyTheme(currentTheme);
    applyFontSize(currentFontSize);
}

function saveState() {
    state.notifications = notifications;
    try {
        if (typeof db !== 'undefined' && typeof doc !== 'undefined' && typeof collection !== 'undefined' && typeof setDoc !== 'undefined') {
            const docRef = doc(collection(db, 'app_states'), 'default');
            setDoc(docRef, state);
        } else {
            console.warn("Firebase not initialized. State changes will not be saved.");
        }
    } catch (e) {
        console.error("Error saving state:", e);
    }
}

/* ---------- Login & Logout Logic ---------- */
async function initAuth() {
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            loginPage.classList.add('hidden');
            appContent.classList.remove('hidden');
            await loadState();
            buildMenu();
            renderContent();
            applyLayout();
            requestNotificationPermission();
            setInterval(checkNotifications, 60000); // Check every minute
            checkNotifications(); // Initial check
            initNotifyEvents();
        } else {
            loginPage.classList.remove('hidden');
            appContent.classList.add('hidden');
        }
    });

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            loginError.textContent = 'Invalid email or password';
            loginError.classList.remove('hidden');
        }
    });

    document.getElementById('forgotPassword').addEventListener('click', async (e) => {
        e.preventDefault();
        const resetEmail = prompt('Enter your email to reset password:');
        if (resetEmail) {
            try {
                await sendPasswordResetEmail(auth, resetEmail);
                alert('Password reset email sent. Check your inbox.');
            } catch (error) {
                alert('Failed to send reset email. Please try again.');
            }
        }
    });

    logoutBtn.addEventListener('click', async () => {
        try {
            await signOut(auth);
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            loginError.classList.add('hidden');
        } catch (error) {
            console.error('Logout failed:', error);
        }
    });
}

/* ---------- Notification System ---------- */
function requestNotificationPermission() {
    if (!("Notification" in window)) return;
    if (Notification.permission !== "granted" && Notification.permission !== "denied") {
        Notification.requestPermission();
    }
}

function addNotification(message, sectionKey, recordIndex) {
    const newNotif = {
        id: Date.now(),
        message,
        sectionKey,
        recordIndex,
        createdAt: todayISO()
    };
    notifications.unshift(newNotif); // Add to front
    saveState();
    updateNotifyCount();
    renderNotifications();
    showDesktopNotification(message);
    beep();
}

function showDesktopNotification(message) {
    if (Notification.permission === "granted") {
        new Notification('Welfare Diary Notification', { body: message });
    }
}

function updateNotifyCount() {
    const count = notifications.length;
    notifyCount.textContent = count;
    notifyCount.classList.toggle('hidden', count === 0);
}

function renderNotifications() {
    notifyList.innerHTML = '';
    notifications.forEach(notif => {
        const li = document.createElement('li');
        li.className = 'p-3 hover:bg-[var(--hover-bg)] cursor-pointer';
        li.innerHTML = `
            <div class="flex justify-between">
                <span>${notif.message}</span>
                <button data-notif-id="${notif.id}" class="text-red-500 hover:text-red-700" aria-label="Delete notification"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
        `;
        li.addEventListener('click', () => {
            selectRowAndNavigate(notif.sectionKey, notif.recordIndex);
            notifyDropdown.classList.add('hidden');
        });
        notifyList.appendChild(li);
    });
    initializeIcons();
}

function initNotifyEvents() {
    notifyBtn.addEventListener('click', () => {
        notifyDropdown.classList.toggle('hidden');
        if (!notifyDropdown.classList.contains('hidden')) {
            renderNotifications();
        }
    });

    notifyList.addEventListener('click', (e) => {
        const delBtn = e.target.closest('button[data-notif-id]');
        if (delBtn) {
            const id = Number(delBtn.dataset.notifId);
            notifications = notifications.filter(n => n.id !== id);
            saveState();
            renderNotifications();
            updateNotifyCount();
            e.stopPropagation();
        }
    });

    clearNotifs.addEventListener('click', () => {
        notifications = [];
        saveState();
        renderNotifications();
        updateNotifyCount();
    });
}

function checkNotifications() {
    const today = todayISO();
    const allSections = getAllSectionsWithKey();
    const lastPendingCheck = localStorage.getItem('lastPendingCheck') || '';
    const isNewDay = lastPendingCheck !== today;

    allSections.forEach(sec => {
        const arr = state[sec.key] || [];
        arr.forEach((rec, idx) => {
            if (rec.status === 'Pending') {
                if (isNewDay) {
                    addNotification(`Letter pending: ${rec.applicantName || rec.subject || 'Entry'} in ${sec.title}`, sec.key, idx);
                }
            }

            if (sec.fields.some(f => f.k === 'missing1')) {
                if (rec.missing1 && !rec.reminder1 && dateDiff(rec.missing1, today) >= 7 && !rec.documentsReceived && rec.status === 'Pending') {
                    addNotification(`Time for Reminder 1 on ${rec.applicantName || rec.subject || 'Entry'} in ${sec.title}`, sec.key, idx);
                }
                if (rec.reminder1 && !rec.reminder2 && dateDiff(rec.reminder1, today) >= 7 && !rec.documentsReceived && rec.status === 'Pending') {
                    addNotification(`Time for Reminder 2 on ${rec.applicantName || rec.subject || 'Entry'} in ${sec.title}`, sec.key, idx);
                }
                if (rec.reminder2 && !rec.reminder3 && dateDiff(rec.reminder2, today) >= 7 && !rec.documentsReceived && rec.status === 'Pending') {
                    addNotification(`Time for Reminder 3 on ${rec.applicantName || rec.subject || 'Entry'} in ${sec.title}`, sec.key, idx);
                }
            }
        });
    });

    if (isNewDay) {
        localStorage.setItem('lastPendingCheck', today);
    }
}

/* ---------- Menu Toggle Logic ---------- */
const DESKTOP_BREAKPOINT = 768;

function applyLayout() {
    const isDesktop = window.innerWidth >= DESKTOP_BREAKPOINT;
    if (isDesktop) {
        sidebarEl.classList.remove('translate-x-[-100%]');
        sidebarEl.style.width = '300px';
    } else {
        sidebarEl.style.width = isMenuOpen ? '300px' : '60px';
        sidebarEl.classList.toggle('translate-x-[-100%]', !isMenuOpen);
    }
    mainContentEl.style.marginLeft = isDesktop ? '300px' : (isMenuOpen ? '300px' : '60px');
    menuToggleEl.classList.toggle('hidden', isDesktop);
    updateMenuButtonIcon();
}

function updateMenuButtonIcon() {
    const iconName = isMenuOpen && window.innerWidth < DESKTOP_BREAKPOINT ? 'x' : 'menu';
    menuToggleEl.innerHTML = `<i data-lucide="${iconName}" class="w-6 h-6 text-[var(--text-primary)]"></i>`;
    initializeIcons();
}

function toggleMenu() {
    if (window.innerWidth < DESKTOP_BREAKPOINT) {
        isMenuOpen = !isMenuOpen;
        applyLayout();
    }
}

const modalEl = document.getElementById('customModal');
const modalTitleEl = document.getElementById('modalTitle');
const modalMessageEl = document.getElementById('modalMessage');
const modalActionsEl = document.getElementById('modalActions');
const modalContentEl = document.getElementById('modalContent');

function showModal(title, message, options = {}) {
    return new Promise(resolve => {
        modalTitleEl.textContent = title;
        modalMessageEl.textContent = message;
        modalActionsEl.innerHTML = '';

        modalEl.classList.remove('hidden');
        modalEl.classList.add('flex');
        setTimeout(() => {
            modalContentEl.classList.remove('scale-95', 'opacity-0');
            modalContentEl.classList.add('scale-100', 'opacity-100');
        }, 10);

        const actions = options.actions || [{ text: 'OK', value: true, style: 'bg-[var(--primary-color)] text-white px-4 py-2 rounded-lg hover:bg-blue-700' }];

        actions.forEach(action => {
            const btn = document.createElement('button');
            btn.textContent = action.text;
            btn.className = `px-4 py-2 rounded-lg text-sm font-medium transition-all ${action.style}`;
            btn.setAttribute('aria-label', action.text);
            btn.addEventListener('click', () => {
                modalContentEl.classList.remove('scale-100', 'opacity-100');
                modalContentEl.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modalEl.classList.remove('flex');
                    modalEl.classList.add('hidden');
                    resolve(action.value);
                }, 300);
            }, { once: true });
            modalActionsEl.appendChild(btn);
        });
    });
}

function applyTheme(theme) {
    currentTheme = theme;
    localStorage.setItem('theme', theme);
    document.documentElement.classList.remove('light', 'dark');
    document.documentElement.classList.add(theme);
    updateThemeIcon();
}

function updateThemeIcon() {
    themeToggle.innerHTML = currentTheme === 'dark' ? `<i data-lucide="moon" class="w-5 h-5"></i>` : `<i data-lucide="sun" class="w-5 h-5"></i>`;
    initializeIcons();
}

function applyFontSize(size) {
    currentFontSize = size;
    localStorage.setItem('fontSize', size);
    document.body.className = size;
}

function buildMenu() {
    menuEl.innerHTML = '';
    SECTIONS.forEach(s => {
        const b = document.createElement('button');
        b.className = `flex items-center gap-3 w-full text-left bg-none border-none text-[#ccc] p-3 rounded-lg hover:bg-[#2c2c2c] hover:text-white transition-all font-medium ${s.id === activeId ? 'bg-[#3b3b3b] text-white' : ''}`;
        b.dataset.id = s.id;
        b.setAttribute('aria-label', s.title);
        b.innerHTML = `
            <i data-lucide="${s.icon}" class="w-5 h-5"></i>
            <span class="hidden md:inline">${s.title}</span>
        `;
        b.addEventListener('click', () => {
            activeId = s.id;
            subActiveId = null;
            filterStatus = null;
            buildMenu();
            renderContent();
            if (window.innerWidth < DESKTOP_BREAKPOINT) setTimeout(() => {
                isMenuOpen = false;
                applyLayout();
            }, 100);
        });
        menuEl.appendChild(b);
    });
    initializeIcons();
}

function renderContent() {
    const isDataTab = activeId !== 'dashboard' && activeId !== 'settings';
    
    searchInput.classList.toggle('md:w-[350px]', !isDataTab); 
    searchInput.classList.toggle('w-full', isDataTab);
    
    tabActions.classList.toggle('hidden', !isDataTab || isSearchMode);

    if (isSearchMode) {
        contentArea.classList.add('hidden');
        searchDedicatedResults.classList.remove('hidden');
        return;
    }

    contentArea.classList.remove('hidden');
    searchDedicatedResults.classList.add('hidden');
    
    if (activeId === 'dashboard') {
        renderDashboard();
    } else if (activeId === 'settings') {
        renderSettings();
    } else if (activeId === 'wmc') {
        if (subActiveId) {
            const subSec = SECTIONS.find(s => s.id === 'wmc').subSections.find(s => s.id === subActiveId);
            renderSection(subSec);
        } else {
            renderWMCSubDashboard();
        }
    } else {
        renderSection(SECTIONS.find(x => x.id === activeId));
    }
}

function getCurrentSec() {
    let sec = SECTIONS.find(s => s.id === activeId);
    if (activeId === 'wmc' && subActiveId) {
        sec = SECTIONS.find(s => s.id === 'wmc').subSections.find(s => s.id === subActiveId);
    }
    return sec;
}

function setSubActiveTab(subId) {
    subActiveId = subId;
    filterStatus = null;
    renderContent();
}

function setSubActiveTabWithFilter(subId, status) {
    subActiveId = subId;
    filterStatus = status;
    renderContent();
}

window.clearFilter = clearFilter;
function clearFilter() {
    filterStatus = null;
    renderContent();
}

function calculateDashboardData(sections) {
    const data = {};
    sections.forEach(sec => {
        if (!sec.key) return;
        const arr = state[sec.key] || [];
        data[sec.id] = {
            total: arr.length,
            pending: arr.filter(r => r.status === 'Pending').length,
            sent: arr.filter(r => r.status === 'Sent').length,
            completed: arr.filter(r => ['Approved', 'Rejected', 'Objection'].includes(r.status)).length,
            approvedRejected: arr.filter(r => ['Approved', 'Rejected'].includes(r.status)).length,
            approved: arr.filter(r => r.status === 'Approved').length,
            rejected: arr.filter(r => r.status === 'Rejected' || r.status === 'Objection').length,
            totalSanctioned: arr.filter(r => r.status === 'Approved').reduce((sum, r) => sum + (Number(r.sanctionedAmount) || 0), 0)
        };
    });
    return data;
}

function renderDashboard() {
    const leafSections = SECTIONS.filter(s => s.key); // Only top-level sections with keys
    const data = calculateDashboardData(leafSections);
    contentArea.innerHTML = `
        <h2 class="text-3xl font-semibold text-[var(--text-primary)] mb-4">Welfare Status Dashboard</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="dashboardContainer">
        </div>
    `;
    const container = document.getElementById('dashboardContainer');
    leafSections.forEach(sec => {
        const sectionData = data[sec.id];
        const sectionHtml = `
            <div class="bg-[var(--card-bg)] shadow-lg border border-[var(--border-color)] rounded-lg overflow-hidden">
                <div class="flex justify-between items-center p-3 bg-[#222222] border-b border-[var(--border-color)] cursor-pointer dashboard-card" onclick="setActiveTab('${sec.id}')">
                    <div class="break-words">
                        <h3 class="text-xl font-semibold text-[var(--text-primary)]">${sec.title}</h3>
                        <p class="text-sm text-[var(--text-secondary)] mt-2">View and manage all entries for this section.</p>
                    </div>
                    <i data-lucide="${sec.icon}" class="w-6 h-6 text-[var(--primary-color)] opacity-75"></i>
                </div>
                <div class="p-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-3">
                    ${renderDashboardCard(sec.id, 'Pending', sectionData.pending, 'clock', 'border-yellow-500 text-yellow-500')}
                    ${renderDashboardCard(sec.id, 'Sent to Higher Office', sectionData.sent, 'send', 'border-blue-500 text-blue-500')}
                    ${renderDashboardCard(sec.id, 'Completed (Final Status)', sectionData.completed, 'check-circle', 'border-green-500 text-green-500')}
                    ${renderDashboardCard(sec.id, 'Approved / Rejected', sectionData.approvedRejected, 'alert-triangle', 'border-red-500 text-red-500')}
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', sectionHtml);
        animateCounter(`count-${sec.id}-Pending`, sectionData.pending);
        animateCounter(`count-${sec.id}-Sent to Higher Office`, sectionData.sent);
        animateCounter(`count-${sec.id}-Completed (Final Status)`, sectionData.completed);
        animateCounter(`count-${sec.id}-Approved / Rejected`, sectionData.approvedRejected);
    });
    initializeIcons();
}

function renderWMCSubDashboard() {
    const subSecs = SECTIONS.find(s => s.id === 'wmc').subSections;
    const data = calculateDashboardData(subSecs);
    contentArea.innerHTML = `
        <h2 class="text-3xl font-semibold text-[var(--text-primary)] mb-4">Welfare Management Committee (WMC)</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="dashboardContainer">
        </div>
        <div class="mt-4">
            <h3 class="text-2xl font-semibold text-[var(--text-primary)] mb-4">Fund Allocation Overview</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-[var(--card-bg)] shadow-lg border border-[var(--border-color)] rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-[var(--text-primary)] mb-2">Sanctioned Amounts by Section</h4>
                    <canvas id="sanctionedChart" class="w-full" style="max-height: 200px;"></canvas>
                </div>
                <div class="bg-[var(--card-bg)] shadow-lg border border-[var(--border-color)] rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-[var(--text-primary)] mb-2">Total Funds</h4>
                    <canvas id="fundsChart" class="w-full" style="max-height: 200px;"></canvas>
                </div>
            </div>
        </div>
        <div class="mt-4" id="addFundsCard"></div>
        <div class="mt-4" id="fundSummary"></div>
    `;
    const container = document.getElementById('dashboardContainer');
    const addFundsContainer = document.getElementById('addFundsCard');
    subSecs.forEach(sec => {
        const sectionData = data[sec.id];
        let sectionHtml;
        if (sec.id === 'wmc_funds') {
            const totalFunds = state[sec.key].reduce((sum, r) => sum + (Number(r.chequeAmount) || 0), 0);
            sectionHtml = `
                <div class="bg-[var(--card-bg)] shadow-lg border border-[var(--border-color)] rounded-lg overflow-hidden col-span-1 sm:col-span-2 lg:col-span-3">
                    <div class="flex justify-between items-center p-3 bg-[#222222] border-b border-[var(--border-color)] cursor-pointer dashboard-card" onclick="setSubActiveTab('${sec.id}')">
                        <div class="break-words">
                            <h3 class="text-xl font-semibold text-[var(--text-primary)]">${sec.title}</h3>
                            <p class="text-sm text-[var(--text-secondary)] mt-2">Manage added funds.</p>
                        </div>
                        <i data-lucide="${sec.icon}" class="w-6 h-6 text-[var(--primary-color)] opacity-75"></i>
                    </div>
                    <div class="p-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-3">
                        ${renderDashboardCard(sec.id, 'Total Entries', sectionData.total, 'file-text', 'border-blue-500 text-blue-500')}
                        ${renderDashboardCard(sec.id, 'Total Funds', totalFunds, 'dollar-sign', 'border-green-500 text-green-500')}
                    </div>
                </div>
            `;
            addFundsContainer.insertAdjacentHTML('beforeend', sectionHtml);
            animateCounter(`count-${sec.id}-Total Entries`, sectionData.total);
            animateCounter(`count-${sec.id}-Total Funds`, totalFunds);
        } else {
            sectionHtml = `
                <div class="bg-[var(--card-bg)] shadow-lg border border-[var(--border-color)] rounded-lg overflow-hidden">
                    <div class="flex justify-between items-center p-3 bg-[#222222] border-b border-[var(--border-color)] cursor-pointer dashboard-card" onclick="setSubActiveTab('${sec.id}')">
                        <div class="break-words">
                            <h3 class="text-xl font-semibold text-[var(--text-primary)]">${sec.title}</h3>
                            <p class="text-sm text-[var(--text-secondary)] mt-2">View and manage all entries for this section.</p>
                        </div>
                        <i data-lucide="${sec.icon}" class="w-6 h-6 text-[var(--primary-color)] opacity-75"></i>
                    </div>
                    <div class="p-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-3">
                        ${renderDashboardCard(sec.id, 'Pending', sectionData.pending, 'clock', 'border-yellow-500 text-yellow-500', 'Pending')}
                        ${renderDashboardCard(sec.id, 'Approved', sectionData.approved, 'check-circle', 'border-green-500 text-green-500', 'Approved')}
                        ${renderDashboardCard(sec.id, 'Rejected', sectionData.rejected, 'x-circle', 'border-red-500 text-red-500', 'Rejected')}
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', sectionHtml);
            animateCounter(`count-${sec.id}-Pending`, sectionData.pending);
            animateCounter(`count-${sec.id}-Approved`, sectionData.approved);
            animateCounter(`count-${sec.id}-Rejected`, sectionData.rejected);
        }
    });
    initializeIcons();

    const sanctionSubSecs = subSecs.filter(sec => sec.id !== 'wmc_funds');
    const labels = sanctionSubSecs.map(sec => sec.title);
    const sanctionedAmounts = sanctionSubSecs.map(sec => data[sec.id].totalSanctioned);
    const ctx = document.getElementById('sanctionedChart').getContext('2d');
    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels.map((label, i) => `${label}: ${new Intl.NumberFormat('en-US').format(sanctionedAmounts[i])} PKR`),
            datasets: [{
                data: sanctionedAmounts,
                backgroundColor: ['#34D399', '#FBBF24', '#F87171'],
                borderColor: ['#2ECC71', '#F59E0B', '#EF4444'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: '#EDEDED',
                        font: { size: 10, weight: 'bold' },
                        boxWidth: 20,
                        boxHeight: 20,
                        padding: 15,
                        generateLabels: (chart) => {
                            const data = chart.data;
                            return data.labels.map((label, i) => ({
                                text: label,
                                fillStyle: data.datasets[0].backgroundColor[i],
                                strokeStyle: data.datasets[0].borderColor[i],
                                lineWidth: 1
                            }));
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'var(--card-bg)',
                    titleColor: '#EDEDED',
                    bodyColor: '#EDEDED',
                    borderColor: 'var(--border-color)',
                    borderWidth: 1
                }
            }
        }
    });

    const totalSanctionedOverall = sanctionSubSecs.reduce((sum, sec) => sum + data[sec.id].totalSanctioned, 0);
    const totalFunds = state['welfare_wmc_funds'].reduce((sum, r) => sum + (Number(r.chequeAmount) || 0), 0);
    const remaining = totalFunds - totalSanctionedOverall;
    const fundsCtx = document.getElementById('fundsChart').getContext('2d');
    new Chart(fundsCtx, {
        type: 'pie',
        data: {
            labels: [
                `Sanctioned: ${new Intl.NumberFormat('en-US').format(totalSanctionedOverall)} PKR`,
                `Remaining: ${new Intl.NumberFormat('en-US').format(remaining)} PKR`
            ],
            datasets: [{
                data: [totalSanctionedOverall, remaining],
                backgroundColor: ['#EF4444', '#10B981'],
                borderColor: ['#DC2626', '#059669'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: 'var(--text-primary)',
                        font: { size: 10, weight: 'bold' },
                        boxWidth: 20,
                        boxHeight: 20,
                        padding: 15
                    }
                },
                tooltip: {
                    backgroundColor: 'var(--card-bg)',
                    titleColor: 'var(--text-primary)',
                    bodyColor: 'var(--text-primary)',
                    borderColor: 'var(--border-color)',
                    borderWidth: 1
                }
            }
        }
    });

    const fundSummaryHtml = `
        <h3 class="text-2xl font-semibold text-[var(--text-primary)] mb-4">Fund Summary</h3>
        <div class="bg-[var(--card-bg)] shadow-lg border border-[var(--border-color)] rounded-lg p-4">
            <p class="text-lg text-[var(--text-primary)] mb-2">Total Funds Added: ${new Intl.NumberFormat('en-US').format(totalFunds)} PKR</p>
            <p class="text-lg text-[var(--text-primary)] mb-2">Total Sanctioned: ${new Intl.NumberFormat('en-US').format(totalSanctionedOverall)} PKR</p>
            <p class="text-lg text-[var(--text-primary)]">Remaining Funds: ${new Intl.NumberFormat('en-US').format(remaining)} PKR</p>
        </div>
    `;
    document.getElementById('fundSummary').innerHTML = fundSummaryHtml;
}

function renderDashboardCard(secId, title, count, icon, colorClasses, status = null) {
    const onclick = status ? `onclick="setSubActiveTabWithFilter('${secId}', '${status}')"` : `onclick="setSubActiveTab('${secId}')"`
    return `
        <div class="p-3 rounded border border-[var(--border-color)] bg-[#222222] shadow-md hover:bg-[var(--hover-bg)] transition-transform duration-200 cursor-pointer dashboard-card" ${onclick}>
            <div class="flex justify-between items-start">
                <i data-lucide="${icon}" class="w-5 h-5 ${colorClasses}"></i>
                <span class="text-3xl font-semibold text-[var(--text-primary)]" id="count-${secId}-${title}">${typeof count === 'number' ? count : new Intl.NumberFormat('en-US').format(count)}</span>
            </div>
            <p class="mt-2 text-sm font-medium text-[var(--text-secondary)] break-words">${title}</p>
        </div>
    `;
}

function animateCounter(id, target) {
    const element = document.getElementById(id);
    if (!element) return;
    const duration = 1500;
    let start = 0;
    const startTime = performance.now();
    function step(timestamp) {
        const progress = timestamp - startTime;
        const percentage = Math.min(progress / duration, 1);
        const value = Math.floor(percentage * target);
        element.textContent = value;
        if (percentage < 1) {
            window.requestAnimationFrame(step);
        } else {
            element.textContent = target;
        }
    }
    window.requestAnimationFrame(step);
}

function setActiveTab(id) {
    activeId = id;
    subActiveId = null;
    filterStatus = null;
    isSearchMode = false;
    searchInput.value = ''; 
    buildMenu();
    renderContent();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function renderSection(sec) {
    selectedIndex = null;
    contentArea.innerHTML = '';
    const q = searchInput.value.trim().toLowerCase(); 
    if (q) {
        contentArea.insertAdjacentHTML('beforeend', `
            <div class="bg-[var(--card-bg)] shadow-md rounded-lg p-4 mb-4">
                <div class="flex items-center justify-between">
                    <span class="text-lg font-medium text-[var(--text-primary)]">Table filtered by: "${searchInput.value}"</span>
                    <button class="bg-gray-600 text-[var(--text-primary)] px-4 py-2 rounded-lg hover:bg-gray-500" onclick="searchInput.value = ''; renderContent();" aria-label="Clear filter">Clear Local Filter</button>
                </div>
            </div>
        `);
    } else if (filterStatus) {
        contentArea.insertAdjacentHTML('beforeend', `
            <div class="bg-[var(--card-bg)] shadow-md rounded-lg p-4 mb-4">
                <div class="flex items-center justify-between">
                    <span class="text-lg font-medium text-[var(--text-primary)]">Showing only ${filterStatus} entries${filterStatus === 'Rejected' ? ' (including Objection)' : ''}</span>
                    <button class="bg-gray-600 text-[var(--text-primary)] px-4 py-2 rounded-lg hover:bg-gray-500" onclick="clearFilter()" aria-label="Show all entries">Show All</button>
                </div>
            </div>
        `);
    }

    if (!filterStatus && !q) { // Only show the form if no filter or search is active
        const formCardHtml = `
            <div class="bg-[var(--card-bg)] shadow-lg border border-[var(--border-color)] rounded-lg p-4">
                <h2 class="text-2xl font-semibold mb-2 text-[var(--text-primary)]">${sec.title}</h2>
                <div class="text-sm text-[var(--text-secondary)] mb-4">Use the form below to add / edit entries.</div>
                <form id="entryForm" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-4">
                    <div class="col-span-1 sm:col-span-2 lg:col-span-2 flex justify-end gap-3 mt-4">
                        <button type="button" id="resetForm" class="bg-gray-600 text-[var(--text-primary)] px-4 py-2 rounded-lg hover:bg-gray-500" aria-label="Reset form">Reset Form</button>
                        <button type="submit" class="bg-[var(--primary-color)] text-white px-4 py-2 rounded-lg hover:bg-blue-700" aria-label="Submit entry"><span id="submitText">Add New Entry</span></button>
                    </div>
                </form>
            </div>
        `;
        contentArea.insertAdjacentHTML('beforeend', formCardHtml);
        const form = document.getElementById('entryForm');
        sec.fields.forEach(f => {
            const wrap = document.createElement('div');
            wrap.className = `flex flex-col gap-2 ${f.full ? 'col-span-1 sm:col-span-2 lg:col-span-2' : ''}`;
            const lbl = document.createElement('label');
            lbl.textContent = f.label;
            lbl.setAttribute('for', f.k);
            lbl.className = 'text-sm font-semibold text-[var(--text-secondary)]';
            wrap.appendChild(lbl);
            let inp;
            const inputClasses = 'w-full p-3 rounded-lg border border-[var(--border-color)] bg-[#222222] text-[var(--text-primary)] focus:ring-2 focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)] transition-all';
            if (f.type === 'select') {
                inp = document.createElement('select');
                inp.className = inputClasses;
                f.options.forEach(opt => {
                    const o = document.createElement('option');
                    o.value = opt;
                    o.textContent = opt;
                    inp.appendChild(o);
                });
            } else if (f.type === 'textarea') {
                inp = document.createElement('textarea');
                inp.rows = 3;
                inp.className = inputClasses + ' resize-y';
                inp.placeholder = `Enter ${f.label.toLowerCase()}`;
            } else {
                inp = document.createElement('input');
                inp.type = f.type || 'text';
                inp.className = inputClasses;
                inp.placeholder = `Enter ${f.label.toLowerCase()}`;
                if (f.type === 'date') inp.value = '';
            }
            inp.id = f.k;
            inp.setAttribute('aria-required', f.optional ? 'false' : 'true');
            wrap.appendChild(inp);
            form.insertBefore(wrap, form.lastElementChild);
        });
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const rec = {};
            let isValid = true;
            sec.fields.forEach(f => {
                const el = document.getElementById(f.k);
                if (el) {
                    if (f.type === 'number' && el.value && isNaN(el.value)) {
                        showModal('Invalid Input', `${f.label} must be a valid number.`, {
                            actions: [{ text: 'OK', value: false, style: 'bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-500' }]
                        });
                        isValid = false;
                    } else {
                        rec[f.k] = el.value;
                    }
                }
            });
            if (!isValid) return;
            const arr = state[sec.key];
            if (selectedIndex === null) arr.push(rec); else arr[selectedIndex] = rec;
            saveState();
            renderSection(sec);
            showModal('Entry Saved', selectedIndex === null ? 'New record added.' : 'Record updated.', {
                actions: [{ text: 'OK', value: true, style: 'bg-[var(--primary-color)] text-white px-4 py-2 rounded-lg hover:bg-blue-700' }]
            });
        });
        document.getElementById('resetForm').addEventListener('click', () => resetForm(sec));
    }
    const tableCardHtml = `
        <div class="max-h-[70vh] overflow-auto rounded-lg border border-[var(--border-color)] shadow-lg max-w-full">
            <table id="dataTable" class="w-full bg-[var(--card-bg)]">
                <thead>
                    <tr class="bg-[#222222] text-left text-xs uppercase text-[var(--text-secondary)] font-semibold">
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                </tbody>
            </table>
        </div>
    `;
    contentArea.insertAdjacentHTML('beforeend', tableCardHtml);
    const theadRow = document.querySelector('#dataTable thead tr');
    const allFields = sec.fields;
    const fieldLabels = {};
    allFields.forEach(f => fieldLabels[f.k] = f.label);
    const hasStatus = allFields.some(f => f.k === 'status');
    const headerKeys = ['sr', ...allFields.map(f => f.k), 'actions'];
    const displayHeaders = headerKeys.map(k => ({
        k,
        label: k === 'sr' ? 'Sr#' : (k === 'actions' ? 'Actions' : (fieldLabels[k] || k.charAt(0).toUpperCase() + k.slice(1)))
    }));
    theadRow.innerHTML = displayHeaders.map(h => `<th class="p-3">${h.label}</th>`).join('');
    renderTable(sec, displayHeaders, hasStatus);
    document.getElementById('dataTableBody').addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const idx = Number(btn.dataset.idx);
        const act = btn.dataset.act;
        const rec = state[sec.key][idx];
        if (act === 'select') {
            selectedIndex = idx;
            fillForm(rec, sec);
            document.getElementById('submitText').textContent = 'Save Changes';
            Array.from(document.querySelectorAll('#dataTableBody tr')).forEach(r => r.classList.remove('ring-2', 'ring-[var(--primary-color)]'));
            btn.closest('tr').classList.add('ring-2', 'ring-[var(--primary-color)]');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            return;
        }
        if (act === 'del') {
            showModal('Confirm Deletion', 'Are you sure you want to delete this entry?', {
                actions: [
                    { text: 'Cancel', value: false, style: 'bg-gray-600 text-[var(--text-primary)] px-4 py-2 rounded-lg hover:bg-gray-500' },
                    { text: 'Delete', value: true, style: 'bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-500' }
                ]
            }).then(result => {
                if (result) {
                    state[sec.key].splice(idx, 1);
                    saveState();
                    renderSection(sec);
                }
            });
            return;
        }
        if (act === 'rem1' && rec.reminder1 === undefined) { rec.reminder1 = todayISO(); saveState(); renderTable(sec, displayHeaders, hasStatus); return; }
        if (act === 'docs' && rec.documentsReceived === undefined) { rec.documentsReceived = todayISO(); saveState(); renderTable(sec, displayHeaders, hasStatus); return; }
        if (act === 'sent' && rec.status !== 'Sent') { rec.status = 'Sent'; saveState(); renderTable(sec, displayHeaders, hasStatus); return; }
    });
    function fillForm(rec, sec) {
        sec.fields.forEach(f => {
            const el = document.getElementById(f.k);
            if (el) el.value = rec[f.k] || '';
        });
    }
}

function renderTable(sec, displayHeaders, hasStatus) {
    const tbody = document.getElementById('dataTableBody');
    if (!tbody) return;
    const fragment = document.createDocumentFragment();
    const arr = state[sec.key] || [];
    const q = searchInput.value.trim().toLowerCase();
    arr.forEach((row, idx) => {
        let hay = '';
        sec.fields.forEach(f => { hay += (row[f.k] || '') + ' '; });
        hay = hay.toLowerCase();
        
        let showRow = true;
        if (q && !hay.includes(q)) showRow = false;

        if (showRow && filterStatus && hasStatus) {
            if (filterStatus === 'Rejected') {
                showRow = row.status === 'Rejected' || row.status === 'Objection';
            } else {
                showRow = row.status === filterStatus;
            }
        }
        
        if (!showRow) return;
        
        const tr = document.createElement('tr');
        tr.className = 'border-b border-[var(--border-color)] hover:bg-[var(--hover-bg)] transition-colors';
        if (idx === selectedIndex) {
            tr.classList.add('ring-2', 'ring-[var(--primary-color)]');
        }
        let rowHtml = '';
        displayHeaders.forEach(h => {
            if (h.k === 'sr') {
                rowHtml += `<td class="p-3 text-center text-sm font-medium text-[var(--text-primary)]">${idx + 1}</td>`;
            } else if (h.k === 'actions') {
                const st = (row.status || 'Pending');
                rowHtml += `
                    <td class="p-3 whitespace-nowrap">
                        <div class="flex gap-2 text-xs">
                            <button class="bg-[var(--primary-color)] text-white px-3 py-1 rounded-lg hover:bg-blue-700" data-act="select" data-idx="${idx}" aria-label="Edit entry">Edit</button>
                            ${hasStatus && st === 'Pending' ? `<button class="bg-[var(--primary-color)] text-white px-3 py-1 rounded-lg hover:bg-blue-700" data-act="sent" data-idx="${idx}" aria-label="Mark as sent">Mark Sent</button>` : ''}
                            <button class="bg-red-600 text-white px-3 py-1 rounded-lg hover:bg-red-500" data-act="del" data-idx="${idx}" aria-label="Delete entry">Delete</button>
                        </div>
                    </td>
                `;
            } else if (h.k === 'status' && hasStatus) {
                const st = (row.status || 'Pending');
                rowHtml += `<td class="p-3"><span class="px-3 py-1 text-xs font-semibold whitespace-nowrap rounded-full status-${st} text-center">${st}</span></td>`;
            } else if (h.k === 'remarks') {
                rowHtml += `<td class="p-3 text-sm text-[var(--text-secondary)] max-w-[150px] truncate">${(row.remarks || '-').substring(0, 50)}...</td>`;
            } else {
                let value = row[h.k] || '-';
                if (['claimAmount', 'sanctionedAmount', 'amount', 'chequeAmount'].includes(h.k)) {
                    value = value !== '-' ? new Intl.NumberFormat('en-US').format(value) : '-';
                    rowHtml += `<td class="p-3 text-sm font-semibold text-green-400 whitespace-nowrap">${value}</td>`;
                } else {
                    rowHtml += `<td class="p-3 text-sm text-[var(--text-secondary)] whitespace-nowrap max-w-[150px] truncate">${value}</td>`;
                }
            }
        });
        tr.innerHTML = rowHtml;
        fragment.appendChild(tr);
    });
    tbody.innerHTML = '';
    tbody.appendChild(fragment);
}

function resetForm(sec) {
    selectedIndex = null;
    document.getElementById('submitText').textContent = 'Add New Entry';
    sec.fields.forEach(f => {
        const el = document.getElementById(f.k);
        if (el) el.value = (f.type === 'date' ? '' : (f.type === 'select' ? f.options[0] : ''));
    });
    Array.from(document.querySelectorAll('#dataTableBody tr')).forEach(r => r.classList.remove('ring-2', 'ring-[var(--primary-color)]'));
}

function renderSettings() {
    contentArea.innerHTML = `
        <h2 class="text-3xl font-semibold text-[var(--text-primary)] mb-4">Application Settings</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="bg-[var(--card-bg)] shadow-lg border border-[var(--border-color)] rounded-lg p-4">
                <div class="flex items-center gap-3 mb-4">
                    <i data-lucide="text-cursor" class="w-6 h-6 text-purple-500"></i>
                    <h3 class="text-xl font-semibold text-[var(--text-primary)]">Font Size</h3>
                </div>
                <p class="text-[var(--text-secondary)] mb-4 text-sm">Adjust the application's text size.</p>
                <div class="flex gap-2">
                    ${renderFontSizeButton('text-base', 'Normal')}
                    ${renderFontSizeButton('text-lg', 'Large')}
                    ${renderFontSizeButton('text-xl', 'Extra Large (XL)')}
                </div>
            </div>
            <div class="bg-[var(--card-bg)] shadow-lg border border-[var(--border-color)] rounded-lg p-4">
                <div class="flex items-center gap-3 mb-4">
                    <i data-lucide="database" class="w-6 h-6 text-green-500"></i>
                    <h3 class="text-xl font-semibold text-[var(--text-primary)]">Export All Data (XLS)</h3>
                </div>
                <p class="text-[var(--text-secondary)] mb-4 text-sm">Download all all sections into a single Excel file.</p>
                <button id="downloadAllXlsx" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-500" aria-label="Export all data to Excel">
                    <i data-lucide="file-spreadsheet" class="w-5 h-5 inline mr-1"></i> Download All Data (XLS)
                </button>
            </div>
            <div class="bg-[var(--card-bg)] shadow-lg border border-[var(--border-color)] rounded-lg p-4">
                <div class="flex items-center gap-3 mb-4">
                    <i data-lucide="upload" class="w-6 h-6 text-indigo-500"></i>
                    <h3 class="text-xl font-semibold text-[var(--text-primary)]">Import Data (JSON)</h3>
                </div>
                <p class="text-[var(--text-secondary)] mb-4 text-sm">Restore data from a JSON file.</p>
                <button id="importAll" class="w-full bg-[var(--primary-color)] text-white px-4 py-2 rounded-lg hover:bg-blue-700" aria-label="Import JSON data">
                    <i data-lucide="file-json" class="w-5 h-5 inline mr-1"></i> Import JSON File
                </button>
            </div>
        </div>
    `;
    initializeIcons();
    document.querySelectorAll('.font-size-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const size = btn.dataset.size;
            applyFontSize(size);
            document.querySelectorAll('.font-size-btn').forEach(b => b.classList.remove('bg-[var(--primary-color)]', 'text-white'));
            btn.classList.add('bg-[var(--primary-color)]', 'text-white');
        });
        if (btn.dataset.size === currentFontSize) {
            btn.classList.add('bg-[var(--primary-color)]', 'text-white');
        } else {
            btn.classList.add('bg-gray-600', 'text-[var(--text-primary)]');
        }
    });
    document.getElementById('downloadAllXlsx').addEventListener('click', downloadAllXlsx);
    document.getElementById('importAll').addEventListener('click', handleImport);
}

function renderFontSizeButton(size, label) {
    return `
        <button class="font-size-btn px-3 py-1 rounded-lg text-sm" data-size="${size}" aria-label="Set font size to ${label}">
            ${label}
        </button>
    `;
}

function getAllSectionsWithKey() {
    let all = [];
    SECTIONS.forEach(sec => {
        if (sec.key) all.push(sec);
        if (sec.subSections) sec.subSections.forEach(sub => {
            if (sub.key) all.push(sub);
        });
    });
    return all;
}

function prepareRowsForSection(sec) {
    const arr = state[sec.key] || [];
    const fields = sec.fields;
    const headers = fields.map(f => f.label.split('(')[0].trim() || f.label);
    const rows = [['Sr#', ...headers]];
    arr.forEach((r, index) => {
        const row = [index + 1];
        fields.forEach(f => row.push(r[f.k] || ''));
        rows.push(row);
    });
    return rows;
}

function saveArrayAsFile(data, filename) {
    const blob = new Blob([data], { type: 'application/octet-stream' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
}

document.getElementById('exportTabXlsx').addEventListener('click', async () => {
    const sec = getCurrentSec();
    if (!sec || !sec.key) {
        showModal('Export Error', 'Please select a data section to export.', {
            actions: [{ text: 'OK', value: false, style: 'bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-500' }]
        });
        return;
    }
    try {
        const rows = prepareRowsForSection(sec);
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(rows);
        XLSX.utils.book_append_sheet(wb, ws, sec.title.substring(0, 31));
        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        saveArrayAsFile(wbout, `${sec.title.replace(/\s+/g, '_')}_Diary_Export.xlsx`);
        showModal('Export Complete', `The data for '${sec.title}' has been exported.`, {
            actions: [{ text: 'Got It', value: true, style: 'bg-[var(--primary-color)] text-white px-4 py-2 rounded-lg hover:bg-blue-700' }]
        });
    } catch (e) {
        console.error('Export failed:', e);
        showModal('Export Failed', 'An error occurred while exporting the data.', {
            actions: [{ text: 'Close', value: false, style: 'bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-500' }]
        });
    }
});

async function downloadAllXlsx() {
    showModal('Exporting', 'Please wait while the data is being exported...', {
        actions: []
    });
    try {
        const wb = XLSX.utils.book_new();
        getAllSectionsWithKey().forEach(sec => {
            const rows = prepareRowsForSection(sec);
            const ws = XLSX.utils.aoa_to_sheet(rows);
            XLSX.utils.book_append_sheet(wb, ws, sec.title.substring(0, 31));
        });
        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        saveArrayAsFile(wbout, `Welfare_All_Sections_Diary.xlsx`);
        showModal('Export Complete', 'All data sections exported.', {
            actions: [{ text: 'OK', value: true, style: 'bg-[var(--primary-color)] text-white px-4 py-2 rounded-lg hover:bg-blue-700' }]
        });
    } catch (e) {
        console.error('Export failed:', e);
        showModal('Export Failed', 'An error occurred while exporting the data.', {
            actions: [{ text: 'Close', value: false, style: 'bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-500' }]
        });
    }
}

function handleImport() {
    const inp = document.createElement('input');
    inp.type = 'file';
    inp.accept = '.json';
    inp.onchange = e => {
        const f = e.target.files[0];
        if (!f) return;
        const r = new FileReader();
        r.onload = ev => {
            try {
                const parsed = JSON.parse(ev.target.result);
                if (typeof parsed === 'object') {
                    state = parsed;
                    SECTIONS.forEach(sec => {
                        if (sec.key && !state[sec.key]) state[sec.key] = [];
                        if (sec.subSections) sec.subSections.forEach(sub => { if (sub.key && !state[sub.key]) state[sub.key] = []; });
                    });
                    saveState();
                    buildMenu();
                    renderContent();
                    showModal('Import Successful', 'Data restored from JSON.', {
                        actions: [{ text: 'Done', value: true, style: 'bg-[var(--primary-color)] text-white px-4 py-2 rounded-lg hover:bg-blue-700' }]
                    });
                } else {
                    showModal('Import Failed', 'File format incorrect.', {
                        actions: [{ text: 'Close', value: false, style: 'bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-500' }]
                    });
                }
            } catch {
                showModal('Import Failed', 'Invalid JSON content.', {
                    actions: [{ text: 'Close', value: false, style: 'bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-500' }]
                });
            }
        };
        r.readAsText(f);
    };
    inp.click();
}

function selectRowAndNavigate(key, index) {
    const allSections = getAllSectionsWithKey();
    const sec = allSections.find(s => s.key === key);
    if (!sec) return;

    if (key.includes('welfare_wmc_')) {
        activeId = 'wmc';
        subActiveId = sec.id;
    } else {
        activeId = sec.id;
        subActiveId = null;
    }
    
    selectedIndex = index;
    filterStatus = null;
    isSearchMode = false;
    searchInput.value = ''; 

    buildMenu();
    renderContent(); 

    setTimeout(() => {
        const targetRow = document.querySelector(`#dataTableBody tr:nth-child(${index + 1})`);
        if (targetRow) {
            targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }, 100);
}
window.selectRowAndNavigate = selectRowAndNavigate;

function performCrossTabSearch(query, clearInput) {
    const q = query.trim().toLowerCase();
    
    if (q.length === 0) {
        isSearchMode = false;
        if (clearInput) searchInput.value = '';
        renderContent();
        return;
    }

    isSearchMode = true; 
    
    if (clearInput) {
        searchInput.value = ''; 
    }

    const allSections = getAllSectionsWithKey();
    const searchResults = {};
    let totalResults = 0;

    allSections.forEach(sec => {
        const arr = state[sec.key] || [];
        const searchRecords = arr.map((row, originalIndex) => ({
            row,
            originalIndex,
            hay: sec.fields.map(f => row[f.k] || '').join(' ').toLowerCase()
        })).filter(item => item.hay.includes(q));

        if (searchRecords.length > 0) {
            searchResults[sec.id] = {
                section: sec,
                results: searchRecords
            };
            totalResults += searchRecords.length;
        }
    });

    renderContent(); 
    
    const resultsContainer = searchDedicatedResults;
    resultsContainer.innerHTML = '';

    let resultHtml = `
        <h2 class="text-3xl font-semibold text-[var(--text-primary)] mb-4">${clearInput ? 'Dedicated Search Results' : 'Real-time Search'} for: "${query}"</h2>
        <p class="text-xl text-[var(--text-secondary)] mb-6">${totalResults} result(s) found across ${Object.keys(searchResults).length} section(s).</p>
        <div id="searchResultsContainerBody" class="flex flex-col gap-6"></div>
    `;
    resultsContainer.insertAdjacentHTML('beforeend', resultHtml);
    const resultsBody = document.getElementById('searchResultsContainerBody');

    if (totalResults === 0) {
        resultsBody.innerHTML = '<p class="text-lg text-red-400">No results found.</p>';
    } else {
        Object.values(searchResults).forEach(item => {
            const sec = item.section;
            const results = item.results;
            
            let sectionHtml = `
                <div class="bg-[var(--card-bg)] shadow-lg border border-[var(--border-color)] rounded-lg overflow-hidden">
                    <h3 class="text-xl font-bold p-3 bg-[#222222] text-[var(--text-primary)]">${sec.title} (${results.length} result${results.length !== 1 ? 's' : ''})</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full bg-[var(--card-bg)]">
                            <thead>
                                <tr class="bg-[#2a2a2a] text-left text-xs uppercase text-[var(--text-secondary)] font-semibold">
                                    <th class="p-3">Sr#</th>
                                    <th class="p-3">Applicant / Subject</th>
                                    ${sec.fields.some(f => f.k === 'status') ? '<th class="p-3">Status</th>' : ''}
                                    <th class="p-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${results.map(item => {
                                    const row = item.row;
                                    const originalIndex = item.originalIndex;
                                    const applicant = row.applicantName || row.subject || '-';
                                    const status = row.status || 'Pending';
                                    const hasStatusField = sec.fields.some(f => f.k === 'status');

                                    return `
                                        <tr class="border-b border-[var(--border-color)] hover:bg-[var(--hover-bg)] transition-colors">
                                            <td class="p-3 text-center text-sm font-medium text-[var(--text-primary)]">${originalIndex + 1}</td>
                                            <td class="p-3 text-sm text-[var(--text-secondary)] max-w-[200px] truncate">${applicant}</td>
                                            ${hasStatusField ? `<td class="p-3"><span class="px-3 py-1 text-xs font-semibold whitespace-nowrap rounded-full status-${status} text-center">${status}</span></td>` : ''}
                                            <td class="p-3 whitespace-nowrap">
                                                <button class="bg-[var(--primary-color)] text-white px-3 py-1 rounded-lg hover:bg-blue-700 text-xs" 
                                                    onclick="selectRowAndNavigate('${sec.key}', ${originalIndex})" aria-label="View/Edit entry">
                                                    View/Edit
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            resultsBody.insertAdjacentHTML('beforeend', sectionHtml);
        });
    }
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

window.onload = async function() {
    
    searchInput.addEventListener('input', debounce(() => {
        const query = searchInput.value;
        const sec = getCurrentSec();

        if (activeId === 'dashboard' || isSearchMode || query.length > 0) {
            performCrossTabSearch(query, false); 
        } 
        else if (sec && sec.key && query.length === 0) {
            isSearchMode = false;
            renderContent();
        }
        else if (sec && sec.key) {
            const allFields = sec.fields;
            const hasStatus = allFields.some(f => f.k === 'status');
            const fieldLabels = {};
            allFields.forEach(f => fieldLabels[f.k] = f.label);
            const headerKeys = ['sr', ...allFields.map(f => f.k), 'actions'];
            const displayHeaders = headerKeys.map(k => ({
                k,
                label: k === 'sr' ? 'Sr#' : (k === 'actions' ? 'Actions' : fieldLabels[k] || k.charAt(0).toUpperCase() + k.slice(1))
            }));
            renderTable(sec, displayHeaders, hasStatus);
        }

    }, 300));
    
    searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault(); 
            performCrossTabSearch(searchInput.value, true); 
        }
    });

    menuToggleEl.addEventListener('click', toggleMenu);
    window.addEventListener('resize', applyLayout);
    themeToggle.addEventListener('click', () => {
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        applyTheme(newTheme);
    });
    await initAuth();
};
</script>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getFirestore, collection, getDoc, setDoc, doc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCVj-Eb9wNAaqwFyGdRgC7uyR24O2jjOIw",
    authDomain: "spuwelfarediary.firebaseapp.com",
    projectId: "spuwelfarediary",
    storageBucket: "spuwelfarediary.firebasestorage.app",
    messagingSenderId: "976541344867",
    appId: "1:976541344867:web:96f6e70b42f0ab33808456"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  window.db = db;
  window.auth = auth;
  window.getDoc = getDoc;
  window.setDoc = setDoc;
  window.doc = doc;
  window.collection = collection;
  window.signInWithEmailAndPassword = signInWithEmailAndPassword;
  window.signOut = signOut;
  window.onAuthStateChanged = onAuthStateChanged;
  window.sendPasswordResetEmail = sendPasswordResetEmail;
 </script>

</body>
</html>

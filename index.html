<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Welfare Branch Diary (Secure)</title>
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --sidebar-bg: #1E1E1E;
            --content-bg: #121212;
            --card-bg: #1B1B1B;
            --primary-color: #3B82F6;
            --text-primary: #EDEDED;
            --text-secondary: #A1A1AA;
            --border-color: #333333;
            --hover-bg: #2A2A2A;
            --gradient-bg: linear-gradient(145deg, #1B1B1B, #252525);
        }

        .light {
            --sidebar-bg: #FFFFFF;
            --content-bg: #F3F4F6;
            --card-bg: #FFFFFF;
            --primary-color: #2563EB;
            --text-primary: #1F2937;
            --text-secondary: #4B5563;
            --border-color: #D1D5DB;
            --hover-bg: #F3F4F6;
            --gradient-bg: linear-gradient(145deg, #FFFFFF, #F3F4F6);
        }

        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--content-bg);
            color: var(--text-primary);
            overflow: hidden;
            user-select: none; /* Make text unselectable for basic protection */
        }

        .sidebar-container {
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            transition: transform 0.3s ease-in-out;
            z-index: 50;
        }

        .dashboard-card {
            transition: all 0.3s ease;
            background: var(--gradient-bg);
            word-break: break-word;
            min-height: 120px;
        }
        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.8);
            background: var(--hover-bg);
        }

        .status-Pending { background-color: #292415; color: #facc15; }
        .status-Sent { background-color: #1a2c4e; color: #60a5fa; }
        .status-Approved { background-color: #1a4235; color: #34d399; }
        .status-Objection { background-color: #551e1e; color: #f87171; }
        .status-Rejected { background-color: #442a5a; color: #c4b5fd; }

        input::placeholder, textarea::placeholder {
            color: var(--text-secondary);
            opacity: 0.5;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
    </style>
</head>
<body class="text-base h-screen flex flex-col" oncontextmenu="return false;">
    
    <div id="loginPage" class="fixed inset-0 z-[100] flex items-center justify-center bg-[var(--content-bg)]">
        <div class="bg-[var(--card-bg)] p-8 rounded-xl shadow-2xl max-w-md w-full transform transition-all hover:-translate-y-1">
            <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-6 text-center">Login to Welfare Diary</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="email" class="text-sm font-semibold text-[var(--text-secondary)]">Email</label>
                    <input type="email" id="email" class="mt-1 w-full p-3 rounded-lg border border-[var(--border-color)] bg-[#222222] text-[var(--text-primary)] focus:ring-2 focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)] transition-all" placeholder="Enter email" required aria-required="true">
                </div>
                <div>
                    <label for="password" class="text-sm font-semibold text-[var(--text-secondary)]">Password</label>
                    <input type="password" id="password" class="mt-1 w-full p-3 rounded-lg border border-[var(--border-color)] bg-[#222222] text-[var(--text-primary)] focus:ring-2 focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)] transition-all" placeholder="Enter password" required aria-required="true">
                </div>
                <div class="text-right">
                    <a href="#" id="forgotPassword" class="text-blue-500 text-sm hover:underline">Forgot Password?</a>
                </div>
                <button type="submit" class="w-full bg-[var(--primary-color)] text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-all">Login</button>
            </form>
            <p id="loginError" class="text-red-500 text-sm mt-4 hidden">Invalid email or password</p>
            <p id="authError" class="text-red-500 text-sm mt-2 hidden">Access Restricted: You are not an Admin.</p>
        </div>
    </div>

    <div class="hidden flex h-screen w-full overflow-hidden" id="appContent">
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden" onclick="toggleMenu()"></div>

        <aside id="sidebar" class="sidebar-container flex flex-col w-[280px] h-full fixed md:static transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out shrink-0">
            <div class="flex items-center justify-start gap-3 px-4 py-4 border-b border-[var(--border-color)]">
                <img src="./logo.jpg" alt="Logo" class="w-10 h-10 rounded-md object-cover shadow-md" onerror="this.onerror=null; this.src='https://via.placeholder.com/40?text=WL'" />
                <div>
                    <span class="text-[var(--text-primary)] font-semibold text-lg block">Welfare Diary</span>
                    <span class="text-[var(--text-secondary)] text-xs uppercase tracking-wider">Special Protection Unit</span>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar mt-2">
                <div class="space-y-1 px-2" id="menu"></div>
            </div>
            <div class="mt-auto border-t border-[var(--border-color)] p-4">
                <p class="text-xs text-[var(--text-secondary)] text-center">¬© 2025 Developed by Hashim Ali</p>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full w-full relative overflow-hidden bg-[var(--content-bg)]">
            <div class="md:hidden flex items-center justify-between p-4 border-b border-[var(--border-color)] bg-[var(--card-bg)] shrink-0">
                <div class="flex items-center gap-3">
                    <button id="menuToggle" class="p-2 rounded-lg bg-[var(--primary-color)] text-white hover:bg-blue-700">
                        <i data-lucide="menu" class="w-5 h-5"></i>
                    </button>
                    <span class="font-semibold text-[var(--text-primary)]">Welfare Diary</span>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-6" id="mainScrollArea">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6" id="topBar">
                    <input type="search" id="search" 
                        class="w-full md:w-[400px] p-3 rounded-full border border-[var(--border-color)] bg-[var(--card-bg)] text-[var(--text-primary)] 
                        focus:ring-2 focus:ring-[var(--primary-color)] transition-all duration-300 shadow-lg" 
                        placeholder="Search employees, cases, or records..." aria-label="Search entries" />
                    <div class="flex items-center gap-2 justify-end">
                         <div id="tabActions" class="hidden"> 
                            </div>
                        <div id="notifyContainer" class="relative">
                            <button id="notifyBtn" class="p-2 rounded-full bg-gray-700 text-[var(--text-primary)] hover:bg-gray-600">
                                <i data-lucide="bell" class="w-5 h-5"></i>
                                <span id="notifyCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1.5 hidden">0</span>
                            </button>
                            <div id="notifyDropdown" class="hidden absolute right-0 mt-2 w-80 bg-[var(--card-bg)] border border-[var(--border-color)] rounded-lg shadow-xl z-[60] max-h-96 overflow-y-auto custom-scrollbar">
                                <ul id="notifyList" class="divide-y divide-[var(--border-color)]"></ul>
                                <button id="clearNotifs" class="w-full p-2 text-center text-sm text-[var(--text-secondary)] hover:bg-[var(--hover-bg)]">Clear All</button>
                            </div>
                        </div>
                        <button id="themeToggle" class="p-2 rounded-full bg-gray-700 text-[var(--text-primary)] hover:bg-gray-600">
                            <i data-lucide="moon" class="w-5 h-5"></i>
                        </button>
                        <button id="logoutBtn" class="p-2 rounded-full bg-gray-700 text-[var(--text-primary)] hover:bg-gray-600">
                            <i data-lucide="log-out" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <div id="searchDedicatedResults" class="flex flex-col gap-4 hidden"></div>
                <div id="contentArea" class="flex flex-col gap-6 pb-10"></div>
            </div>
        </main>
    </div>

    <div id="customModal" class="fixed inset-0 bg-black bg-opacity-70 z-[1000] hidden flex items-center justify-center p-4">
        <div class="bg-[var(--card-bg)] p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-95 opacity-0" id="modalContent">
            <h3 id="modalTitle" class="text-xl font-bold mb-3 text-[var(--text-primary)]"></h3>
            <p id="modalMessage" class="mb-5 text-[var(--text-secondary)]"></p>
            <div id="modalActions" class="flex justify-end gap-3"></div>
        </div>
    </div>

<script>
/* ---------- CONFIGURATION & SECURITY CONSTANTS ---------- */
// üõ†Ô∏è IMPORTANT: Replace this with your actual Admin UID from Firebase Console
const ADMIN_UID = "uNM86CoUooP4q1zK0o4HvYpQuPv1"; 

const SECTIONS = [
    { id:'dashboard', title:'Dashboard', icon:'layout-dashboard' },
    { id:'medical', title:'Medical Financial Assistance', key:'welfare_medical', icon:'dollar-sign', fields:[
        {k:'diaryNo',label:'Diary No.',type:'number'},
        {k:'dateReceived',label:'Date Received',type:'date'},
        {k:'applicantName',label:'Applicant Name',type:'text'},
        {k:'subject',label:'Subject',type:'text'},
        {k:'fromOffice',label:'From Office',type:'text'},
        {k:'claimAmount',label:'Claim Amount',type:'number'},
        {k:'illnessReason',label:'Illness / Reason',type:'text'},
        {k:'missing1',label:'Missing Docs Letter 1st',type:'date', optional: true},
        {k:'reminder1',label:'Reminder 1',type:'date', optional: true},
        {k:'reminder2',label:'Reminder 2',type:'date', optional: true},
        {k:'documentsReceived',label:'Documents Received',type:'date', optional: true},
        {k:'sentHigher',label:'Sent to Higher Office',type:'date', optional: true},
        {k:'status',label:'Status',type:'select',options:['Pending','Sent','Approved','Rejected','Objection']},
        {k:'remarks',label:'Remarks',type:'textarea', full:true}
    ]},
    { id:'wedding', title:'Wedding Gift', key:'welfare_wedding', icon:'gift', fields:[
        {k:'diaryNo',label:'Diary No.',type:'number'},
        {k:'dateReceived',label:'Date Received',type:'date'},
        {k:'applicantName',label:'Applicant Name',type:'text'},
        {k:'subject',label:'Subject',type:'text'},
        {k:'brideName',label:'Bride Name',type:'text'},
        {k:'amount',label:'Amount',type:'number'},
        {k:'fromOffice',label:'From Office',type:'text'},
        {k:'missing1',label:'Missing Docs Letter 1st',type:'date', optional: true},
        {k:'reminder1',label:'Reminder 1',type:'date', optional: true},
        {k:'reminder2',label:'Reminder 2',type:'date', optional: true},
        {k:'documentsReceived',label:'Documents Received',type:'date', optional: true},
        {k:'sentHigher',label:'Sent to Higher Office',type:'date', optional: true},
        {k:'status',label:'Status',type:'select',options:['Pending','Sent','Approved','Rejected','Objection']},
        {k:'remarks',label:'Remarks',type:'textarea', full:true}
    ]},
    { id:'scholarship', title:'Scholarships', key:'welfare_scholarship', icon:'graduation-cap', fields:[
        {k:'diaryNo',label:'Diary No.',type:'number'},
        {k:'dateReceived',label:'Date Received',type:'date'},
        {k:'applicantName',label:'Applicant Name',type:'text'},
        {k:'subject',label:'Subject',type:'text'},
        {k:'studentName',label:'Student Name',type:'text'},
        {k:'amount',label:'Amount',type:'number'},
        {k:'fromOffice',label:'From Office',type:'text'},
        {k:'missing1',label:'Missing Docs Letter 1st',type:'date', optional: true},
        {k:'reminder1',label:'Reminder 1',type:'date', optional: true},
        {k:'reminder2',label:'Reminder 2',type:'date', optional: true},
        {k:'documentsReceived',label:'Documents Received',type:'date', optional: true},
        {k:'sentHigher',label:'Sent to Higher Office',type:'date', optional: true},
        {k:'status',label:'Status',type:'select',options:['Pending','Sent','Approved','Rejected','Objection']},
        {k:'remarks',label:'Remarks',type:'textarea', full:true}
    ]},
    { id:'basicpay', title:'Last Month Basic Pay', key:'welfare_basicpay', icon:'wallet', fields:[
        {k:'diaryNo',label:'Diary No.',type:'number'},
        {k:'dateReceived',label:'Date Received',type:'date'},
        {k:'applicantName',label:'Applicant Name',type:'text'},
        {k:'subject',label:'Subject',type:'text'},
        {k:'fromOffice',label:'From Office',type:'text'},
        {k:'amount',label:'Amount',type:'number'},
        {k:'documentsReceived',label:'Documents Received',type:'date', optional: true},
        {k:'sentHigher',label:'Sent to Higher Office',type:'date', optional: true},
        {k:'status',label:'Status',type:'select',options:['Pending','Sent','Approved','Rejected','Objection']},
        {k:'remarks',label:'Remarks',type:'textarea', full:true}
    ]},
    { id:'misc', title:'Misc Letter', key:'welfare_misc', icon:'mail', fields:[
        {k:'diaryNo',label:'Diary No.',type:'number'},
        {k:'dateReceived',label:'Date Received',type:'date'},
        {k:'applicantName',label:'Applicant Name',type:'text'},
        {k:'subject',label:'Subject',type:'text'},
        {k:'fromOffice',label:'From Office',type:'text'},
        {k:'missing1',label:'Missing Docs Letter 1st',type:'date', optional: true},
        {k:'reminder1',label:'Reminder 1',type:'date', optional: true},
        {k:'reminder2',label:'Reminder 2',type:'date', optional: true},
        {k:'reminder3',label:'Reminder 3',type:'date', optional: true},
        {k:'documentsReceived',label:'Documents Received',type:'date', optional: true},
        {k:'sentHigher',label:'Sent to Higher Office',type:'date', optional: true},
        {k:'status',label:'Status',type:'select',options:['Pending','Sent','Approved','Rejected','Objection']},
        {k:'remarks',label:'Remarks',type:'textarea', full:true}
    ]},
    { id:'wmc', title:'Welfare Management Committee (WMC)', icon:'users', subSections:[
        { id:'wmc_medical', title:'Medical Financial Assistance', key:'welfare_wmc_medical', icon:'dollar-sign', fields:[
            {k:'diaryNo',label:'Diary No.',type:'number'},
            {k:'dateReceived',label:'Date Received',type:'date'},
            {k:'applicantName',label:'Applicant Name',type:'text'},
            {k:'subject',label:'Subject',type:'text'},
            {k:'fromOffice',label:'From Office',type:'text'},
            {k:'claimAmount',label:'Claim Amount',type:'number'},
            {k:'sanctionedAmount',label:'Sanctioned Amount',type:'number'},
            {k:'chequeNo',label:'Cheque No.',type:'text'},
            {k:'chequeDate',label:'Cheque Date',type:'date'},
            {k:'status',label:'Status',type:'select',options:['Pending','Sent','Approved','Rejected','Objection']},
            {k:'remarks',label:'Remarks',type:'textarea', full:true}
        ]},
        { id:'wmc_financial', title:'Financial Assistance', key:'welfare_wmc_financial', icon:'wallet', fields:[
            {k:'diaryNo',label:'Diary No.',type:'number'},
            {k:'dateReceived',label:'Date Received',type:'date'},
            {k:'applicantName',label:'Applicant Name',type:'text'},
            {k:'subject',label:'Subject',type:'text'},
            {k:'fromOffice',label:'From Office',type:'text'},
            {k:'claimAmount',label:'Claim Amount',type:'number'},
            {k:'sanctionedAmount',label:'Sanctioned Amount',type:'number'},
            {k:'chequeNo',label:'Cheque No.',type:'text'},
            {k:'chequeDate',label:'Cheque Date',type:'date'},
            {k:'status',label:'Status',type:'select',options:['Pending','Sent','Approved','Rejected','Objection']},
            {k:'remarks',label:'Remarks',type:'textarea', full:true}
        ]},
        { id:'wmc_other', title:'Other', key:'welfare_wmc_other', icon:'file-text', fields:[
            {k:'diaryNo',label:'Diary No.',type:'number'},
            {k:'dateReceived',label:'Date Received',type:'date'},
            {k:'applicantName',label:'Applicant Name',type:'text'},
            {k:'subject',label:'Subject',type:'text'},
            {k:'fromOffice',label:'From Office',type:'text'},
            {k:'claimAmount',label:'Claim Amount',type:'number'},
            {k:'sanctionedAmount',label:'Sanctioned Amount',type:'number'},
            {k:'chequeNo',label:'Cheque No.',type:'text'},
            {k:'chequeDate',label:'Cheque Date',type:'date'},
            {k:'status',label:'Status',type:'select',options:['Pending','Sent','Approved','Rejected','Objection']},
            {k:'remarks',label:'Remarks',type:'textarea', full:true}
        ]},
        { id:'wmc_funds', title:'Add Funds', key:'welfare_wmc_funds', icon:'dollar-sign', fields:[
            {k:'diaryNo',label:'Diary No.',type:'number'},
            {k:'chequeNumber',label:'Cheque Number',type:'text'},
            {k:'chequeDate',label:'Cheque Date',type:'date'},
            {k:'letterNumber',label:'Letter Number',type:'text'},
            {k:'letterDate',label:'Letter Date',type:'date'},
            {k:'chequeAmount',label:'Cheque Amount',type:'number'},
            {k:'remarks',label:'Remarks',type:'textarea', full:true}
        ]}
    ]},
    { id:'settings', title:'Settings', icon: 'settings'}
];

// STATE & VARIABLES
let state = {}, activeId = 'dashboard', subActiveId = null, filterStatus = null, selectedIndex = null;
let isSearchMode = false;
let currentTheme = localStorage.getItem('theme') || 'dark';
let currentFontSize = localStorage.getItem('fontSize') || 'text-base';
let isMenuOpen = false;
let notifications = [];

// DOM ELEMENTS
const sidebarEl = document.getElementById('sidebar');
const sidebarOverlay = document.getElementById('sidebarOverlay');
const menuToggleEl = document.getElementById('menuToggle');
const menuEl = document.getElementById('menu');
const contentArea = document.getElementById('contentArea');
const searchDedicatedResults = document.getElementById('searchDedicatedResults');
const topBar = document.getElementById('topBar');
const searchInput = document.getElementById('search');
const tabActions = document.getElementById('tabActions');
const loginPage = document.getElementById('loginPage');
const appContent = document.getElementById('appContent');
const loginForm = document.getElementById('loginForm');
const loginError = document.getElementById('loginError');
const authError = document.getElementById('authError');
const logoutBtn = document.getElementById('logoutBtn');
const notifyBtn = document.getElementById('notifyBtn');
const notifyDropdown = document.getElementById('notifyDropdown');
const notifyList = document.getElementById('notifyList');
const notifyCount = document.getElementById('notifyCount');
const clearNotifs = document.getElementById('clearNotifs');
const themeToggle = document.getElementById('themeToggle');
const modalEl = document.getElementById('customModal');
const modalTitleEl = document.getElementById('modalTitle');
const modalMessageEl = document.getElementById('modalMessage');
const modalActionsEl = document.getElementById('modalActions');
const modalContentEl = document.getElementById('modalContent');

/* ---------- SECURITY FUNCTIONS & UTILS ---------- */

// üîπ XSS Protection: Clean all inputs
function cleanInput(value) {
    if (typeof value !== 'string') return value;
    return value
        .trim()
        .replace(/<[^>]*>?/gm, "") // Remove HTML tags
        .replace(/[{}$<>]/g, ""); // Remove specific dangerous chars
}

// üîπ Strong Input Validation
function validateInputs(record, fields) {
    for (const f of fields) {
        const val = record[f.k];
        
        // 1. Required Fields check
        if ((f.type === 'date' || f.k === 'applicantName' || f.k === 'status') && !f.optional) {
             if (!val || val === '') return `${f.label} is required.`;
        }

        // 2. Numeric Checks (Amount cannot be negative)
        if ((f.k.toLowerCase().includes('amount') || f.k.toLowerCase().includes('diary')) && val) {
            if (isNaN(val)) return `${f.label} must be a number.`;
            if (Number(val) < 0) return `${f.label} cannot be negative.`;
        }
        
        // 3. CNIC Validation (13 Digits)
        if ((f.k.toLowerCase().includes('cnic') || f.k.toLowerCase().includes('identity')) && val) {
            if (!/^\d{13}$/.test(val)) return "CNIC must be exactly 13 digits (numbers only).";
        }

        // 4. Phone Validation (11 Digits)
        if ((f.k.toLowerCase().includes('phone') || f.k.toLowerCase().includes('contact')) && val) {
            if (!/^\d{11}$/.test(val)) return "Phone number must be exactly 11 digits.";
        }

        // 5. Dropdown Status Validation
        if (f.type === 'select' && f.options && val) {
            if (!f.options.includes(val)) return `Invalid value for ${f.label}.`;
        }
    }
    return null; // No errors
}

// üîπ Disable Inspect Element (Basic Deterrent)
document.onkeydown = function (e) {
    if (e.key === "F12" || (e.ctrlKey && e.shiftKey && e.key === "I")) {
        return false;
    }
};

function debounce(func, wait) {
    let timeout;
    return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

function initializeIcons() {
    if (typeof lucide !== 'undefined') lucide.createIcons();
}

function todayISO() {
    const d = new Date();
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().slice(0, 10);
}

function dateDiff(date1, date2) {
    const d1 = new Date(date1);
    const d2 = new Date(date2);
    return Math.floor((d2 - d1) / (1000 * 60 * 60 * 24));
}

function beep(duration = 200, frequency = 440, volume = 100) {
    const myAudioContext = new (window.AudioContext || window.webkitAudioContext)();
    return new Promise((resolve) => {
        let oscillatorNode = myAudioContext.createOscillator();
        let gainNode = myAudioContext.createGain();
        oscillatorNode.connect(gainNode);
        oscillatorNode.frequency.value = frequency;
        oscillatorNode.type = "square";
        gainNode.connect(myAudioContext.destination);
        gainNode.gain.value = volume * 0.01;
        oscillatorNode.start(myAudioContext.currentTime);
        oscillatorNode.stop(myAudioContext.currentTime + duration * 0.001);
        oscillatorNode.onended = resolve;
    });
}

/* ---------- State Management ---------- */
async function loadState() {
    try {
        if (typeof db !== 'undefined' && typeof doc !== 'undefined') {
            const docRef = doc(collection(db, 'app_states'), 'default');
            const snap = await getDoc(docRef);
            if (snap.exists()) state = snap.data();
            else state = {};
        } else {
            state = {};
        }
    } catch (e) {
        console.error("Error loading state:", e);
        showModal('Connection Error', 'Failed to load data from server. Please check internet connection.');
        state = {};
    }
    // Ensure structure exists
    SECTIONS.forEach(sec => {
        if (sec.key && !state[sec.key]) state[sec.key] = [];
        if (sec.subSections) {
            sec.subSections.forEach(subSec => {
                if (subSec.key && !state[subSec.key]) state[subSec.key] = [];
            });
        }
    });
    if (!state.notifications) state.notifications = [];
    notifications = state.notifications;
    updateNotifyCount();
    applyTheme(currentTheme);
    applyFontSize(currentFontSize);
}

async function saveState() {
    state.notifications = notifications;
    try {
        if (typeof db !== 'undefined' && typeof doc !== 'undefined') {
            // üî• 6. Firestore Error Handling (Try/Catch wrapper for writes)
            const docRef = doc(collection(db, 'app_states'), 'default');
            await setDoc(docRef, state);
        }
    } catch (e) {
        console.error("Error saving state:", e);
        showModal('Save Failed', 'Could not save data to server. Please check your internet connection.');
        throw e; // Stop execution
    }
}

/* ---------- Auth (Enhanced Security) ---------- */
async function initAuth() {
    onAuthStateChanged(auth, async (user) => {
        // üî• 1. ADMIN SECURITY CHECK (Critical)
        if (user) {
            if (user.uid === ADMIN_UID) {
                // ‚úÖ User is Admin - Allow Access
                loginPage.classList.add('hidden');
                appContent.classList.remove('hidden');
                appContent.classList.add('flex');
                
                await loadState();
                buildMenu();
                renderContent();
                requestNotificationPermission();
                
                setInterval(checkNotifications, 60000);
                checkNotifications();
                initNotifyEvents();
            } else {
                // ‚õî User Logged in BUT NOT ADMIN
                console.warn("Unauthorized access attempt by UID:", user.uid);
                appContent.classList.add('hidden');
                appContent.classList.remove('flex');
                loginPage.classList.remove('hidden');
                authError.classList.remove('hidden');
                authError.textContent = "SECURITY ALERT: Unauthorized UID. You are not an Admin.";
                
                // Force Logout immediately
                await signOut(auth);
            }
        } else {
            // No User
            loginPage.classList.remove('hidden');
            appContent.classList.add('hidden');
            appContent.classList.remove('flex');
        }
    });

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            console.error(error);
            loginError.textContent = 'Invalid email or password';
            loginError.classList.remove('hidden');
        }
    });

    document.getElementById('forgotPassword').addEventListener('click', async (e) => {
        e.preventDefault();
        const resetEmail = prompt('Enter your email to reset password:');
        if (resetEmail) {
            try {
                await sendPasswordResetEmail(auth, resetEmail);
                alert('Password reset email sent.');
            } catch (error) {
                alert('Failed to send reset email.');
            }
        }
    });

    logoutBtn.addEventListener('click', async () => {
        await signOut(auth);
        document.getElementById('email').value = '';
        document.getElementById('password').value = '';
        loginError.classList.add('hidden');
        authError.classList.add('hidden');
    });
}

/* ---------- UI Logic ---------- */
function toggleMenu() {
    isMenuOpen = !isMenuOpen;
    if (isMenuOpen) {
        sidebarEl.classList.remove('-translate-x-full');
        sidebarOverlay.classList.remove('hidden');
    } else {
        sidebarEl.classList.add('-translate-x-full');
        sidebarOverlay.classList.add('hidden');
    }
}

function closeMobileMenu() {
    if (window.innerWidth < 768) {
        isMenuOpen = false;
        sidebarEl.classList.add('-translate-x-full');
        sidebarOverlay.classList.add('hidden');
    }
}

/* ---------- Notifications ---------- */
function requestNotificationPermission() {
    if ("Notification" in window && Notification.permission !== "granted" && Notification.permission !== "denied") {
        Notification.requestPermission();
    }
}

function addNotification(message, sectionKey, recordIndex) {
    const newNotif = { id: Date.now(), message, sectionKey, recordIndex, createdAt: todayISO() };
    notifications.unshift(newNotif);
    saveState();
    updateNotifyCount();
    renderNotifications();
    if (Notification.permission === "granted") new Notification('Welfare Diary', { body: message });
    beep();
}

function updateNotifyCount() {
    notifyCount.textContent = notifications.length;
    notifyCount.classList.toggle('hidden', notifications.length === 0);
}

function renderNotifications() {
    notifyList.innerHTML = '';
    notifications.forEach(notif => {
        const li = document.createElement('li');
        li.className = 'p-3 hover:bg-[var(--hover-bg)] cursor-pointer';
        li.innerHTML = `
            <div class="flex justify-between items-start gap-2">
                <span class="text-sm">${notif.message}</span>
                <button data-notif-id="${notif.id}" class="text-red-500 hover:text-red-700 p-1"><i data-lucide="x" class="w-3 h-3"></i></button>
            </div>
        `;
        li.addEventListener('click', (e) => {
            if(!e.target.closest('button')) {
                selectRowAndNavigate(notif.sectionKey, notif.recordIndex);
                notifyDropdown.classList.add('hidden');
            }
        });
        notifyList.appendChild(li);
    });
    initializeIcons();
}

function initNotifyEvents() {
    notifyBtn.addEventListener('click', () => {
        notifyDropdown.classList.toggle('hidden');
        if (!notifyDropdown.classList.contains('hidden')) renderNotifications();
    });
    notifyList.addEventListener('click', (e) => {
        const delBtn = e.target.closest('button[data-notif-id]');
        if (delBtn) {
            e.stopPropagation();
            const id = Number(delBtn.dataset.notifId);
            notifications = notifications.filter(n => n.id !== id);
            saveState();
            renderNotifications();
            updateNotifyCount();
        }
    });
    clearNotifs.addEventListener('click', () => {
        notifications = [];
        saveState();
        renderNotifications();
        updateNotifyCount();
    });
}

function checkNotifications() {
    const today = todayISO();
    const allSections = getAllSectionsWithKey();
    const lastCheck = localStorage.getItem('lastPendingCheck') || '';
    const isNewDay = lastCheck !== today;

    allSections.forEach(sec => {
        const arr = state[sec.key] || [];
        arr.forEach((rec, idx) => {
            if (isNewDay && rec.status === 'Pending') {
                addNotification(`Letter pending: ${rec.applicantName || rec.subject || 'Entry'} in ${sec.title}`, sec.key, idx);
            }
            if (sec.fields.some(f => f.k === 'missing1')) {
                const checkReminder = (dateField, nextDateField, msg) => {
                    if (rec[dateField] && !rec[nextDateField] && dateDiff(rec[dateField], today) >= 7 && !rec.documentsReceived && rec.status === 'Pending') {
                        addNotification(msg, sec.key, idx);
                    }
                };
                checkReminder('missing1', 'reminder1', `Time for Reminder 1: ${rec.applicantName}`);
                checkReminder('reminder1', 'reminder2', `Time for Reminder 2: ${rec.applicantName}`);
                checkReminder('reminder2', 'reminder3', `Time for Reminder 3: ${rec.applicantName}`);
            }
        });
    });
    if (isNewDay) localStorage.setItem('lastPendingCheck', today);
}

/* ---------- Theme & Modal ---------- */
function showModal(title, message, options = {}) {
    return new Promise(resolve => {
        modalTitleEl.textContent = title;
        modalMessageEl.textContent = message;
        modalActionsEl.innerHTML = '';
        modalEl.classList.remove('hidden');
        modalEl.classList.add('flex');
        setTimeout(() => {
            modalContentEl.classList.remove('scale-95', 'opacity-0');
            modalContentEl.classList.add('scale-100', 'opacity-100');
        }, 10);
        const actions = options.actions || [{ text: 'OK', value: true, style: 'bg-[var(--primary-color)] text-white px-4 py-2 rounded-lg hover:bg-blue-700' }];
        actions.forEach(action => {
            const btn = document.createElement('button');
            btn.textContent = action.text;
            btn.className = `px-4 py-2 rounded-lg text-sm font-medium transition-all ${action.style}`;
            btn.addEventListener('click', () => {
                modalContentEl.classList.remove('scale-100', 'opacity-100');
                modalContentEl.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modalEl.classList.remove('flex');
                    modalEl.classList.add('hidden');
                    resolve(action.value);
                }, 300);
            }, { once: true });
            modalActionsEl.appendChild(btn);
        });
    });
}

function applyTheme(theme) {
    currentTheme = theme;
    localStorage.setItem('theme', theme);
    document.documentElement.classList.remove('light', 'dark');
    document.documentElement.classList.add(theme);
    themeToggle.innerHTML = currentTheme === 'dark' ? `<i data-lucide="moon" class="w-5 h-5"></i>` : `<i data-lucide="sun" class="w-5 h-5"></i>`;
    initializeIcons();
}

function applyFontSize(size) {
    currentFontSize = size;
    localStorage.setItem('fontSize', size);
    document.body.className = `${size} h-screen flex flex-col`;
}

/* ---------- Rendering Logic ---------- */
function buildMenu() {
    menuEl.innerHTML = '';
    SECTIONS.forEach(s => {
        const b = document.createElement('button');
        b.className = `flex items-center gap-3 w-full text-left bg-transparent text-[var(--text-secondary)] p-3 rounded-lg hover:bg-[#2c2c2c] hover:text-white transition-all font-medium ${s.id === activeId ? 'bg-[#3b3b3b] text-white' : ''}`;
        b.innerHTML = `<i data-lucide="${s.icon}" class="w-5 h-5"></i><span>${s.title}</span>`;
        b.addEventListener('click', () => {
            activeId = s.id;
            subActiveId = null;
            filterStatus = null;
            buildMenu();
            renderContent();
            closeMobileMenu();
        });
        menuEl.appendChild(b);
    });
    initializeIcons();
}

function renderContent() {
    const isDataTab = activeId !== 'dashboard' && activeId !== 'settings';
    searchInput.classList.toggle('md:w-[400px]', !isDataTab); 
    searchInput.classList.toggle('w-full', isDataTab);
    tabActions.classList.toggle('hidden', !isDataTab || isSearchMode);

    // Clear previous tab actions content
    tabActions.innerHTML = '';
    
    if (isSearchMode) {
        contentArea.classList.add('hidden');
        searchDedicatedResults.classList.remove('hidden');
        return;
    }
    contentArea.classList.remove('hidden');
    searchDedicatedResults.classList.add('hidden');
    
    if (activeId === 'dashboard') renderDashboard();
    else if (activeId === 'settings') renderSettings();
    else if (activeId === 'wmc') {
        if (subActiveId) {
            const subSec = SECTIONS.find(s => s.id === 'wmc').subSections.find(s => s.id === subActiveId);
            renderSection(subSec);
            
            // Add Export Button for WMC Sub-Sections
            if (subSec.key) {
                 tabActions.innerHTML = `
                    <button onclick="exportCurrentTabXlsx()" class="p-2 rounded-full bg-green-600 text-white hover:bg-green-700 transition-all" title="Export This Tab">
                        <i data-lucide="file-text" class="w-5 h-5"></i>
                    </button>
                 `;
                 initializeIcons();
            }
            
        } else {
            renderWMCSubDashboard();
        }
    } else {
        const sec = SECTIONS.find(x => x.id === activeId);
        renderSection(sec);
        
        // Add Export Button for main sections
        if (sec.key) {
            tabActions.innerHTML = `
                <button onclick="exportCurrentTabXlsx()" class="p-2 rounded-full bg-green-600 text-white hover:bg-green-700 transition-all" title="Export This Tab">
                    <i data-lucide="file-text" class="w-5 h-5"></i>
                </button>
            `;
            initializeIcons();
        }
    }
}

function getCurrentSec() {
    let sec = SECTIONS.find(s => s.id === activeId);
    if (activeId === 'wmc' && subActiveId) sec = SECTIONS.find(s => s.id === 'wmc').subSections.find(s => s.id === subActiveId);
    return sec;
}

function setSubActiveTab(subId) {
    subActiveId = subId;
    filterStatus = null;
    renderContent();
}

function setSubActiveTabWithFilter(subId, status) {
    subActiveId = subId;
    filterStatus = status;
    renderContent();
}

window.clearFilter = () => { filterStatus = null; renderContent(); };

function calculateDashboardData(sections) {
    const data = {};
    sections.forEach(sec => {
        if (!sec.key) return;
        const arr = state[sec.key] || [];
        data[sec.id] = {
            total: arr.length,
            pending: arr.filter(r => r.status === 'Pending').length,
            sent: arr.filter(r => r.status === 'Sent').length,
            completed: arr.filter(r => ['Approved', 'Rejected', 'Objection'].includes(r.status)).length,
            approvedRejected: arr.filter(r => ['Approved', 'Rejected'].includes(r.status)).length,
            approved: arr.filter(r => r.status === 'Approved').length,
            rejected: arr.filter(r => r.status === 'Rejected' || r.status === 'Objection').length,
            totalSanctioned: arr.filter(r => r.status === 'Approved').reduce((sum, r) => sum + (Number(r.sanctionedAmount) || 0), 0)
        };
    });
    return data;
}

function renderDashboard() {
    const leafSections = SECTIONS.filter(s => s.key);
    const data = calculateDashboardData(leafSections);
    contentArea.innerHTML = `
        <h2 class="text-3xl font-semibold text-[var(--text-primary)] mb-4">Welfare Status Dashboard</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="dashboardContainer"></div>
    `;
    const container = document.getElementById('dashboardContainer');
    
    leafSections.forEach(sec => {
        const d = data[sec.id];
        container.insertAdjacentHTML('beforeend', `
            <div class="bg-[var(--card-bg)] shadow-lg border border-[var(--border-color)] rounded-lg overflow-hidden flex flex-col h-full">
                <div class="flex justify-between items-center p-3 bg-[#222222] border-b border-[var(--border-color)] cursor-pointer dashboard-card" onclick="activeId='${sec.id}';renderContent()">
                    <div><h3 class="text-lg font-bold text-[var(--text-primary)]">${sec.title}</h3></div>
                    <i data-lucide="${sec.icon}" class="w-5 h-5 text-[var(--primary-color)]"></i>
                </div>
                <div class="p-3 grid grid-cols-2 gap-2 flex-1 content-start">
                    <div class="bg-[#262626] p-2 rounded text-center cursor-pointer border border-yellow-900" onclick="activeId='${sec.id}';renderContent()">
                        <div class="text-xl font-bold text-yellow-500">${d.pending}</div><div class="text-xs text-[var(--text-secondary)]">Pending</div>
                    </div>
                    <div class="bg-[#262626] p-2 rounded text-center cursor-pointer border border-blue-900" onclick="activeId='${sec.id}';renderContent()">
                        <div class="text-xl font-bold text-blue-500">${d.sent}</div><div class="text-xs text-[var(--text-secondary)]">Sent HQ</div>
                    </div>
                    <div class="bg-[#262626] p-2 rounded text-center cursor-pointer border border-green-900" onclick="activeId='${sec.id}';renderContent()">
                        <div class="text-xl font-bold text-green-500">${d.completed}</div><div class="text-xs text-[var(--text-secondary)]">Completed</div>
                    </div>
                    <div class="bg-[#262626] p-2 rounded text-center cursor-pointer border border-red-900" onclick="activeId='${sec.id}';renderContent()">
                        <div class="text-xl font-bold text-red-500">${d.approvedRejected}</div><div class="text-xs text-[var(--text-secondary)]">Appr/Rej</div>
                    </div>
                </div>
            </div>
        `);
    });
    initializeIcons();
}

function renderDashboardCard(secId, title, count, icon, classes) {
    return `
        <div class="p-2 rounded border border-[var(--border-color)] bg-[#262626] flex flex-col items-center justify-center text-center">
            <span class="text-2xl font-bold text-[var(--text-primary)]">${count}</span>
            <span class="text-xs text-[var(--text-secondary)] mt-1">${title}</span>
        </div>
    `;
}

function renderWMCSubDashboard() {
    const subSecs = SECTIONS.find(s => s.id === 'wmc').subSections;
    const data = calculateDashboardData(subSecs);
    contentArea.innerHTML = `
        <h2 class="text-3xl font-semibold text-[var(--text-primary)] mb-4">WMC Dashboard</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="wmcContainer"></div>
        <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-[var(--card-bg)] p-4 rounded-lg border border-[var(--border-color)]">
                <h4 class="text-lg font-bold mb-2">Sanctioned Amounts</h4>
                <canvas id="sanctionedChart" style="max-height: 250px;"></canvas>
            </div>
            <div class="bg-[var(--card-bg)] p-4 rounded-lg border border-[var(--border-color)]">
                <h4 class="text-lg font-bold mb-2">Funds Overview</h4>
                <canvas id="fundsChart" style="max-height: 250px;"></canvas>
            </div>
        </div>
        <div id="fundSummary" class="mt-4 p-4 bg-[var(--card-bg)] rounded-lg border border-[var(--border-color)]"></div>
    `;
    const container = document.getElementById('wmcContainer');
    subSecs.forEach(sec => {
        const d = data[sec.id];
        if (sec.id === 'wmc_funds') {
            const totalFunds = state[sec.key].reduce((sum, r) => sum + (Number(r.chequeAmount) || 0), 0);
            container.insertAdjacentHTML('beforeend', `
                <div class="bg-[var(--card-bg)] shadow border border-[var(--border-color)] rounded-lg flex flex-col h-full">
                     <div class="p-3 bg-[#222222] border-b border-[var(--border-color)] cursor-pointer flex justify-between" onclick="setSubActiveTab('${sec.id}')">
                        <h3 class="font-bold">${sec.title}</h3><i data-lucide="${sec.icon}" class="w-5"></i>
                     </div>
                     <div class="p-3 grid grid-cols-2 gap-3 flex-1 content-start">
                        ${renderDashboardCard(sec.id, 'Entries', d.total, 'file-text', '')}
                        ${renderDashboardCard(sec.id, 'Total Funds', new Intl.NumberFormat().format(totalFunds), 'dollar-sign', '')}
                     </div>
                </div>
            `);
        } else {
            container.insertAdjacentHTML('beforeend', `
                <div class="bg-[var(--card-bg)] shadow border border-[var(--border-color)] rounded-lg flex flex-col h-full">
                    <div class="p-3 bg-[#222222] border-b border-[var(--border-color)] cursor-pointer flex justify-between" onclick="setSubActiveTab('${sec.id}')">
                        <h3 class="font-bold">${sec.title}</h3><i data-lucide="${sec.icon}" class="w-5"></i>
                    </div>
                    <div class="p-3 grid grid-cols-2 gap-2 flex-1 content-start">
                        <div class="bg-[#262626] p-2 rounded text-center cursor-pointer border border-yellow-900" onclick="setSubActiveTabWithFilter('${sec.id}','Pending')">
                            <div class="text-xl font-bold text-yellow-500">${d.pending}</div><div class="text-xs text-[var(--text-secondary)]">Pending</div>
                        </div>
                        <div class="bg-[#262626] p-2 rounded text-center cursor-pointer border border-green-900" onclick="setSubActiveTabWithFilter('${sec.id}','Approved')">
                            <div class="text-xl font-bold text-green-500">${d.approved}</div><div class="text-xs text-[var(--text-secondary)]">Approved</div>
                        </div>
                        <div class="bg-[#262626] p-2 rounded text-center cursor-pointer border border-red-900 col-span-2" onclick="setSubActiveTabWithFilter('${sec.id}','Rejected')">
                            <div class="text-xl font-bold text-red-500">${d.rejected}</div><div class="text-xs text-[var(--text-secondary)]">Rejected</div>
                        </div>
                    </div>
                </div>
            `);
        }
    });
    initializeIcons();

    // Charts
    const sanctionSubSecs = subSecs.filter(s => s.id !== 'wmc_funds');
    const sancAmts = sanctionSubSecs.map(s => data[s.id].totalSanctioned);
    new Chart(document.getElementById('sanctionedChart'), {
        type: 'doughnut',
        data: {
            labels: sanctionSubSecs.map(s => s.title),
            datasets: [{ data: sancAmts, backgroundColor: ['#34D399', '#FBBF24', '#F87171'] }]
        },
        options: { plugins: { legend: { position:'right', labels:{ color:'var(--text-primary)' } } } }
    });

    const totalSanctioned = sancAmts.reduce((a,b)=>a+b,0);
    const totalFunds = state['welfare_wmc_funds'].reduce((sum,r)=>sum+(Number(r.chequeAmount)||0),0);
    const remaining = totalFunds - totalSanctioned;
    
    new Chart(document.getElementById('fundsChart'), {
        type: 'pie',
        data: {
            labels: ['Used', 'Remaining'],
            datasets: [{ data: [totalSanctioned, remaining], backgroundColor: ['#EF4444', '#10B981'] }]
        },
        options: { plugins: { legend: { position:'right', labels:{ color:'var(--text-primary)' } } } }
    });

    document.getElementById('fundSummary').innerHTML = `
        <div class="flex flex-wrap gap-6 justify-between items-center text-[var(--text-primary)]">
            <span class="text-lg font-semibold">Total Funds: <span class="text-blue-400">${new Intl.NumberFormat().format(totalFunds)}</span></span>
            <span class="text-lg font-semibold">Sanctioned: <span class="text-red-400">${new Intl.NumberFormat().format(totalSanctioned)}</span></span>
            <span class="text-lg font-semibold">Available: <span class="text-green-400">${new Intl.NumberFormat().format(remaining)}</span></span>
        </div>
    `;
}

function renderSection(sec) {
    selectedIndex = null;
    contentArea.innerHTML = '';
    const q = searchInput.value.trim().toLowerCase();
    
    if (q || filterStatus) {
        contentArea.insertAdjacentHTML('beforeend', `
            <div class="bg-[var(--card-bg)] shadow p-3 rounded-lg flex justify-between items-center">
                <span class="text-[var(--text-primary)] font-medium">
                    ${q ? `Search: "${q}"` : `Filter: ${filterStatus}`}
                </span>
                <button class="bg-gray-600 text-white px-3 py-1 rounded hover:bg-gray-500 text-sm" onclick="searchInput.value='';clearFilter()">Clear</button>
            </div>
        `);
    }

    if (!filterStatus && !q) {
        contentArea.insertAdjacentHTML('beforeend', `
            <div class="bg-[var(--card-bg)] border border-[var(--border-color)] rounded-lg p-5 shadow-lg">
                <h2 class="text-xl font-bold mb-4 text-[var(--text-primary)]">${sec.title} - Entry Form</h2>
                <form id="entryForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${sec.fields.map(f => `
                        <div class="flex flex-col gap-1 ${f.full ? 'col-span-1 md:col-span-2 lg:col-span-3' : ''}">
                            <label for="${f.k}" class="text-xs font-bold uppercase text-[var(--text-secondary)]">${f.label}</label>
                            ${f.type === 'select' ? 
                                `<select id="${f.k}" class="p-2 rounded bg-[#222222] border border-[var(--border-color)] text-white focus:border-[var(--primary-color)] outline-none">
                                    ${f.options.map(o => `<option value="${o}">${o}</option>`).join('')}
                                 </select>` : 
                              f.type === 'textarea' ?
                                `<textarea id="${f.k}" rows="3" class="p-2 rounded bg-[#222222] border border-[var(--border-color)] text-white focus:border-[var(--primary-color)] outline-none" placeholder="${f.label}"></textarea>` :
                                `<input type="${f.type}" id="${f.k}" class="p-2 rounded bg-[#222222] border border-[var(--border-color)] text-white focus:border-[var(--primary-color)] outline-none" placeholder="${f.label}">`
                            }
                        </div>
                    `).join('')}
                    <div class="col-span-full flex justify-end gap-3 mt-2">
                         <button type="button" id="resetForm" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-500">Reset</button>
                         <button type="submit" class="bg-[var(--primary-color)] text-white px-6 py-2 rounded hover:bg-blue-700 font-semibold"><span id="submitText">Save Entry</span></button>
                    </div>
                </form>
            </div>
        `);
        document.getElementById('entryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const rec = {};
            
            // Collect & Clean Data (üî• 2. Input Sanitization applied on save)
            sec.fields.forEach(f => {
                const el = document.getElementById(f.k);
                if(el) rec[f.k] = cleanInput(el.value); 
            });

            // üîπ Validation Check (üî• 3. Strong Validation)
            const errorMsg = validateInputs(rec, sec.fields);
            if (errorMsg) {
                showModal('Validation Error', errorMsg);
                return;
            }

            const arr = state[sec.key];
            if (selectedIndex === null) arr.push(rec); else arr[selectedIndex] = rec;
            
            try {
                await saveState();
                renderSection(sec);
                showModal('Success', 'Record saved successfully.');
            } catch (err) {
                // Error handled in saveState
            }
        });
        document.getElementById('resetForm').addEventListener('click', () => { selectedIndex = null; document.getElementById('entryForm').reset(); document.getElementById('submitText').textContent='Save Entry'; });
    }

    contentArea.insertAdjacentHTML('beforeend', `
        <div class="bg-[var(--card-bg)] border border-[var(--border-color)] rounded-lg overflow-hidden shadow-lg flex flex-col">
            <div class="overflow-x-auto custom-scrollbar">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-[#222222] text-xs uppercase text-[var(--text-secondary)]">
                        <tr>
                            <th class="p-3 border-b border-[var(--border-color)]">Sr#</th>
                            ${sec.fields.map(f => `<th class="p-3 border-b border-[var(--border-color)] whitespace-nowrap">${f.label}</th>`).join('')}
                            <th class="p-3 border-b border-[var(--border-color)] text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody"></tbody>
                </table>
            </div>
        </div>
    `);

    renderTableRows(sec);
}

function renderTableRows(sec) {
    const tbody = document.getElementById('dataTableBody');
    const arr = state[sec.key] || [];
    const q = searchInput.value.trim().toLowerCase();
    const hasStatus = sec.fields.some(f => f.k === 'status');
    
    // üî• 5. UID-BASED BUTTON SECURITY
    const currentUser = auth.currentUser;
    const isAdmin = currentUser && currentUser.uid === ADMIN_UID; 

    let rows = '';
    arr.forEach((row, idx) => {
        let text = Object.values(row).join(' ').toLowerCase();
        if (q && !text.includes(q)) return;
        if (filterStatus && hasStatus) {
            if (filterStatus === 'Rejected' && !['Rejected', 'Objection'].includes(row.status)) return;
            if (filterStatus !== 'Rejected' && row.status !== filterStatus) return;
        }

        // Hide buttons for non-admins using JS
        const actionButtons = isAdmin ? `
            <button class="text-blue-400 hover:text-white mr-2" onclick="editRow('${sec.key}', ${idx})"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
            <button class="text-red-500 hover:text-white" onclick="deleteRow('${sec.key}', ${idx})"><i data-lucide="trash" class="w-4 h-4"></i></button>
        ` : `<span class="text-xs text-gray-500 italic">Read Only</span>`;

        rows += `
            <tr class="border-b border-[var(--border-color)] hover:bg-[var(--hover-bg)] transition-colors group ${idx === selectedIndex ? 'bg-blue-900 bg-opacity-20' : ''}">
                <td class="p-3 text-sm text-center text-[var(--text-secondary)]">${idx+1}</td>
                ${sec.fields.map(f => {
                    let val = row[f.k] || '-';
                    if (['status'].includes(f.k)) return `<td class="p-3"><span class="status-${val} px-2 py-0.5 rounded text-xs">${val}</span></td>`;
                    if (f.type === 'number' && val !== '-') val = new Intl.NumberFormat().format(val);
                    return `<td class="p-3 text-sm whitespace-nowrap max-w-[150px] overflow-hidden text-ellipsis" title="${val}">${val}</td>`;
                }).join('')}
                <td class="p-3 text-right whitespace-nowrap">
                    ${actionButtons}
                </td>
            </tr>
        `;
    });
    tbody.innerHTML = rows || '<tr><td colspan="100" class="p-4 text-center text-[var(--text-secondary)]">No records found</td></tr>';
    initializeIcons();
}

window.editRow = (key, idx) => {
    // üîπ Security: Double check permissions
    if (!auth.currentUser || auth.currentUser.uid !== ADMIN_UID) {
        showModal('Access Denied', 'You do not have permission to edit.');
        return;
    }

    selectedIndex = idx;
    const rec = state[key][idx];
    const sec = getCurrentSec();
    if(document.getElementById('entryForm')) {
        sec.fields.forEach(f => {
            const el = document.getElementById(f.k);
            if(el) el.value = rec[f.k] || '';
        });
        document.getElementById('submitText').textContent = 'Update Entry';
        window.scrollTo({top:0, behavior:'smooth'});
        renderTableRows(sec);
    }
};

window.deleteRow = (key, idx) => {
    // üîπ Security: Double check permissions
    if (!auth.currentUser || auth.currentUser.uid !== ADMIN_UID) {
        showModal('Access Denied', 'You do not have permission to delete.');
        return;
    }

    // üî• 4. DELETE CONFIRMATION STRONG
    const confirmation = prompt("‚ö†Ô∏è CRITICAL ACTION REQURIED\n\nTo permanently delete this record, type 'DELETE' below:");
    
    if(confirmation === 'DELETE') {
        state[key].splice(idx, 1);
        saveState(); // Error handling inside
        renderContent();
    } else {
        if(confirmation !== null) alert("Deletion cancelled. You must type 'DELETE' exactly.");
    }
};

function selectRowAndNavigate(key, index) {
    const allSections = getAllSectionsWithKey();
    const sec = allSections.find(s => s.key === key);
    if (!sec) return;
    if (key.includes('welfare_wmc_')) { activeId = 'wmc'; subActiveId = sec.id; } 
    else { activeId = sec.id; subActiveId = null; }
    selectedIndex = index;
    filterStatus = null;
    isSearchMode = false;
    searchInput.value = '';
    buildMenu();
    renderContent();
    setTimeout(() => {
        window.editRow(key, index);
    }, 100);
}

function getAllSectionsWithKey() {
    let all = [];
    SECTIONS.forEach(sec => {
        if (sec.key) all.push(sec);
        if (sec.subSections) sec.subSections.forEach(sub => { if (sub.key) all.push(sub); });
    });
    return all;
}

function performCrossTabSearch(query) {
    if (!query) { isSearchMode = false; renderContent(); return; }
    isSearchMode = true;
    const resultsContainer = searchDedicatedResults;
    resultsContainer.classList.remove('hidden');
    contentArea.classList.add('hidden');
    resultsContainer.innerHTML = `<h2 class="text-2xl font-bold mb-4">Results for "${query}"</h2>`;
    
    let found = false;
    getAllSectionsWithKey().forEach(sec => {
        const arr = state[sec.key] || [];
        const hits = arr.map((r, i) => ({r, i})).filter(({r}) => Object.values(r).join(' ').toLowerCase().includes(query.toLowerCase()));
        if(hits.length > 0) {
            found = true;
            resultsContainer.insertAdjacentHTML('beforeend', `
                <div class="bg-[var(--card-bg)] border border-[var(--border-color)] rounded-lg mb-4 overflow-hidden">
                    <div class="p-3 bg-[#222222] font-bold">${sec.title} (${hits.length})</div>
                    <table class="w-full text-left">
                         <tbody class="divide-y divide-[var(--border-color)]">
                            ${hits.map(({r, i}) => `
                                <tr class="hover:bg-[var(--hover-bg)] cursor-pointer" onclick="selectRowAndNavigate('${sec.key}', ${i})">
                                    <td class="p-3 text-sm">${r.applicantName || r.subject || 'Record'}</td>
                                    <td class="p-3 text-right text-blue-400 text-sm">View</td>
                                </tr>
                            `).join('')}
                         </tbody>
                    </table>
                </div>
            `);
        }
    });
    if(!found) resultsContainer.innerHTML += '<p class="text-[var(--text-secondary)]">No matches found.</p>';
}

/* ---------- Export / Import / Settings ---------- */

// üî• NEW FUNCTION: EXPORT CURRENT TAB DATA
async function exportCurrentTabXlsx() {
    // Security check
    if (!auth.currentUser || auth.currentUser.uid !== ADMIN_UID) {
        showModal('Access Denied', 'Data export restricted to Admin.');
        return;
    }
    
    try {
        const sec = getCurrentSec();
        if (!sec || !sec.key) {
            showModal('Export Error', 'Cannot export data from this page.');
            return;
        }

        const wb = XLSX.utils.book_new();
        const dateStr = todayISO();
        const arr = state[sec.key] || [];
        
        // Prepare Data for Sheet
        const headers = sec.fields.map(f => f.label);
        const dataRows = arr.map(r => sec.fields.map(f => r[f.k]));

        // Add Header Row with Date at Top
        const sheetData = [
            [`Export Date: ${dateStr}`], // Row 1
            headers,                     // Row 2 (Headers)
            ...dataRows                  // Rows 3+ (Data)
        ];

        const ws = XLSX.utils.aoa_to_sheet(sheetData);
        
        // Determine Sheet Name (max 31 chars) and File Name based on rules
        let sheetName = sec.title;
        let fileName = sec.title;

        if (sec.key === 'welfare_wmc_medical') {
            // EXTRA RULE for WMC Medical Financial Assistance
            sheetName = "Medical Financial Assistance in WMC";
            fileName = "Medical Financial Assistance in WMC";
        }

        // Safe Sheet Name (limit to 31 chars)
        let safeSheetName = sheetName.replace(/[\\/?*[\]]/g, "").substring(0, 31);
        
        XLSX.utils.book_append_sheet(wb, ws, safeSheetName);

        // File name format: TabName_YYYY-MM-DD.xlsx
        XLSX.writeFile(wb, `${fileName}_${dateStr}.xlsx`);
        
        showModal('Export Complete', `${sec.title} data exported successfully!`);
        
    } catch (e) {
        console.error("Individual Export Error:", e);
        showModal('Export Failed', 'An error occurred while creating the Excel file.');
    }
}


function renderSettings() {
    // Check if user is Admin before showing sensitive buttons
    const currentUser = auth.currentUser;
    const isAdmin = currentUser && currentUser.uid === ADMIN_UID;

    const dataActions = isAdmin ? `
        <button onclick="downloadAllXlsx()" class="w-full mb-2 bg-green-600 text-white p-2 rounded hover:bg-green-700">Download All Data (XLSX)</button>
        <button onclick="document.getElementById('importFile').click()" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Import JSON Backup</button>
        <input type="file" id="importFile" class="hidden" accept=".json" onchange="handleImport(this)">
    ` : `<p class="text-sm text-yellow-500 border border-yellow-700 p-2 rounded">Data export/import restricted to Admin.</p>`;

    contentArea.innerHTML = `
        <h2 class="text-3xl font-semibold mb-4 text-[var(--text-primary)]">Settings</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
             <div class="bg-[var(--card-bg)] p-4 rounded border border-[var(--border-color)]">
                <h3 class="font-bold mb-2">Data Management</h3>
                ${dataActions}
             </div>
             <div class="bg-[var(--card-bg)] p-4 rounded border border-[var(--border-color)]">
                <h3 class="font-bold mb-2">Appearance</h3>
                <div class="flex gap-2">
                    <button class="px-3 py-1 bg-gray-700 rounded text-white text-sm" onclick="applyFontSize('text-sm')">Small</button>
                    <button class="px-3 py-1 bg-gray-700 rounded text-white text-base" onclick="applyFontSize('text-base')">Normal</button>
                    <button class="px-3 py-1 bg-gray-700 rounded text-white text-lg" onclick="applyFontSize('text-lg')">Large</button>
                </div>
             </div>
        </div>
    `;
}

// üî• 7. ADVANCED XLS EXPORT (Multi-sheet) - UNTOUCHED AS REQUESTED
async function downloadAllXlsx() {
    if (!auth.currentUser || auth.currentUser.uid !== ADMIN_UID) return;

    try {
        const wb = XLSX.utils.book_new();
        const dateStr = todayISO();
        
        getAllSectionsWithKey().forEach(sec => {
            const arr = state[sec.key] || [];
            
            // Prepare Data for Sheet
            // Headers
            const headers = sec.fields.map(f => f.label);
            
            // Rows
            const dataRows = arr.map(r => sec.fields.map(f => r[f.k]));

            // Add Header Row with Date at Top
            const sheetData = [
                [`Report Date: ${dateStr}`], // Row 1
                headers,                     // Row 2 (Headers)
                ...dataRows                  // Rows 3+ (Data)
            ];

            const ws = XLSX.utils.aoa_to_sheet(sheetData);
            
            // üî• FIXED: Custom Sheet Naming for WMC Medical Tab to avoid conflict
            let exportTitle = sec.title;
            if (sec.key === 'welfare_wmc_medical') {
                exportTitle = "Medical Financial Assistance in WMC";
            }
            
            // Safe Sheet Name (limit to 31 chars)
            let safeName = exportTitle.replace(/[\\/?*[\]]/g, "").substring(0, 31);
            
            XLSX.utils.book_append_sheet(wb, ws, safeName);
        });

        XLSX.writeFile(wb, `All_Data_${dateStr}.xlsx`);
    } catch (e) {
        console.error("Export Error:", e);
        showModal('Export Failed', 'An error occurred while creating the Excel file.');
    }
}

function handleImport(input) {
    if (!auth.currentUser || auth.currentUser.uid !== ADMIN_UID) return;

    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const json = JSON.parse(e.target.result);
            if (!json || typeof json !== 'object') throw new Error("Invalid format");
            state = json;
            saveState(); // Will catch errors if permissions denied
            showModal('Success', 'Data imported successfully!');
            setTimeout(() => location.reload(), 1500);
        } catch(err) { 
            console.error(err);
            showModal('Import Error', 'Invalid JSON file or corrupted data.');
        }
    };
    reader.readAsText(file);
}

searchInput.addEventListener('input', debounce((e) => {
    const val = e.target.value;
    if(activeId === 'dashboard') performCrossTabSearch(val);
    else renderContent();
}, 300));

window.onload = initAuth;
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getFirestore, collection, getDoc, setDoc, doc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  const firebaseConfig = {
    apiKey: "AIzaSyCVj-Eb9wNAaqwFyGdRgC7uyR24O2jjOIw",
    authDomain: "spuwelfarediary.firebaseapp.com",
    projectId: "spuwelfarediary",
    storageBucket: "spuwelfarediary.firebasestorage.app",
    messagingSenderId: "976541344867",
    appId: "1:976541344867:web:96f6e70b42f0ab33808456"
  };
  const app = initializeApp(firebaseConfig);
  window.db = getFirestore(app);
  window.auth = getAuth(app);
  window.getDoc = getDoc; window.setDoc = setDoc; window.doc = doc; window.collection = collection;
  window.signInWithEmailAndPassword = signInWithEmailAndPassword;
  window.signOut = signOut; window.onAuthStateChanged = onAuthStateChanged; window.sendPasswordResetEmail = sendPasswordResetEmail;
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Welfare Branch Diary</title>
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --sidebar-bg: #1E1E1E;
            --content-bg: #121212;
            --card-bg: #1B1B1B;
            --primary-color: #3B82F6;
            --text-primary: #EDEDED;
            --text-secondary: #A1A1AA;
            --border-color: #333333;
            --hover-bg: #2A2A2A;
            --gradient-bg: linear-gradient(145deg, #1B1B1B, #252525);
        }

        .light {
            --sidebar-bg: #FFFFFF;
            --content-bg: #F3F4F6;
            --card-bg: #FFFFFF;
            --primary-color: #2563EB;
            --text-primary: #1F2937;
            --text-secondary: #4B5563;
            --border-color: #D1D5DB;
            --hover-bg: #F3F4F6;
            --gradient-bg: linear-gradient(145deg, #FFFFFF, #F3F4F6);
        }

        html, body {
            height: 100%;
            margin: 0;
            overflow-x: hidden;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--content-bg);
            color: var(--text-primary);
        }

        .sidebar {
            background-color: var(--sidebar-bg);
            position: fixed;
            top: 0; left: 0;
            height: 100vh;
            z-index: 100;
            box-shadow: 4px 0 12px rgba(0,0,0,0.6);
            transition: width 0.3s ease;
            overflow-x: hidden;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .sidebar::-webkit-scrollbar { display: none; }

        .dashboard-card {
            transition: all 0.3s ease;
            background: var(--gradient-bg);
            min-height: 120px;
        }
        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.8);
            background: var(--hover-bg);
        }

        .status-Pending { background-color: #292415; color: #facc15; }
        .status-Sent { background-color: #1a2c4e; color: #60a5fa; }
        .status-Approved { background-color: #1a4235; color: #34d399; }
        .status-Objection { background-color: #551e1e; color: #f87171; }
        .status-Rejected { background-color: #442a5a; color: #c4b5fd; }

        input::placeholder, textarea::placeholder { color: var(--text-secondary); opacity: 0.6; }

        /* Modern Dark Scrollbar */
        .dark ::-webkit-scrollbar { width: 6px; height: 6px; }
        .dark ::-webkit-scrollbar-track { background: #1a1a1a; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #555; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #777; }

        /* ZOOM-PROOF DASHBOARD */
        #dashboardContainer { min-width: 1000px; }
        @media (max-width: 1280px) { #dashboardContainer { min-width: 800px; } }
        @media (max-width: 1024px) { #dashboardContainer { min-width: 600px; } }
        @media (max-width: 768px)  { #dashboardContainer { min-width: 400px; } }
    </style>
</head>
<body class="text-base">

    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center bg-[var(--content-bg)]">
        <div class="bg-[var(--card-bg)] p-8 rounded-xl shadow-2xl max-w-md w-full">
            <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-6 text-center">Login to Welfare Diary</h2>
            <form id="loginForm" class="space-y-4">
                <input type="email" id="email" class="w-full p-3 rounded-lg border border-[var(--border-color)] bg-[#222222] text-[var(--text-primary)]" placeholder="Enter email" required>
                <input type="password" id="password" class="w-full p-3 rounded-lg border border-[var(--border-color)] bg-[#222222] text-[var(--text-primary)]" placeholder="Enter password" required>
                <div class="text-right"><a href="#" id="forgotPassword" class="text-blue-500 text-sm hover:underline">Forgot Password?</a></div>
                <button type="submit" class="w-full bg-[var(--primary-color)] text-white p-3 rounded-lg font-semibold hover:bg-blue-700">Login</button>
            </form>
            <p id="loginError" class="text-red-500 text-sm mt-4 hidden">Invalid email or password</p>
        </div>
    </div>

    <!-- Main App -->
    <div class="hidden min-h-screen flex" id="appContent">
        <div id="customModal" class="fixed inset-0 bg-black bg-opacity-70 z-[1000] hidden flex items-center justify-center p-4">
            <div class="bg-[var(--card-bg)] p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-95 opacity-0" id="modalContent">
                <h3 id="modalTitle" class="text-xl font-bold mb-3 text-[var(--text-primary)]"></h3>
                <p id="modalMessage" class="mb-5 text-[var(--text-secondary)]"></p>
                <div id="modalActions" class="flex justify-end gap-3"></div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar w-[60px] md:w-[300px] flex flex-col flex-shrink-0">
            <div class="flex items-center justify-start gap-3 px-4 py-4 border-b border-[var(--border-color)]">
                <img src="./logo.jpg" alt="Logo" class="w-10 h-10 rounded-md" onerror="this.src='https://via.placeholder.com/40?text=WL'"/>
                <div class="hidden md:block">
                    <span class="text-[var(--text-primary)] font-semibold text-lg block">Welfare Branch Diary</span>
                    <span class="text-[var(--text-secondary)] text-sm">Special Protection Unit</span>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto mt-2"><div class="space-y-1 px-2" id="menu"></div></div>
            <div class="p-4 border-t border-[var(--border-color)]">
                <button id="logoutBtn" class="flex items-center gap-3 w-full text-left p-3 rounded-lg hover:bg-[#2c2c2c]">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                    <span class="hidden md:inline">Logout</span>
                </button>
                <p class="text-xs text-[var(--text-secondary)] text-center hidden md:block mt-2">Â© 2025 Developed by Rao Hashim Ali</p>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-x-auto min-w-0">
            <div class="max-w-7xl mx-auto px-4 py-6">
                <button id="menuToggle" class="md:hidden fixed top-4 left-4 z-50 p-2 rounded-full bg-[var(--primary-color)] text-white">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>

                <div class="flex flex-wrap items-center justify-between gap-4 mb-6" id="topBar">
                    <input type="search" id="search" class="flex-1 min-w-[280px] p-3 rounded-full border border-[var(--border-color)] bg-[var(--card-bg)] text-[var(--text-primary)]" placeholder="Search employees, cases, or records..."/>
                    <div class="flex gap-3">
                        <div id="notifyContainer" class="relative">
                            <button id="notifyBtn" class="p-2 rounded-full bg-gray-700"><i data-lucide="bell" class="w-5 h-5"></i><span id="notifyCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-2 hidden">0</span></button>
                            <div id="notifyDropdown" class="hidden absolute right-0 mt-2 w-80 bg-[var(--card-bg)] border rounded-lg shadow-lg max-h-96 overflow-y-auto"></div>
                        </div>
                        <button id="themeToggle" class="p-2 rounded-full bg-gray-700"><i data-lucide="moon" class="w-5 h-5"></i></button>
                        <div id="tabActions" class="flex gap-2 hidden">
                            <button id="exportTabXlsx" class="flex items-center gap-1 px-4 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-600">
                                <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Export Tab (XLS)
                            </button>
                        </div>
                    </div>
                </div>

                <div id="searchDedicatedResults" class="hidden"></div>
                <div id="contentArea"></div>
            </div>
        </div>
    </div>

<script>
// ==================== FULL JS WITH ALL FIXES ====================
const SECTIONS = [
    { id:'dashboard', title:'Dashboard', icon:'layout-dashboard' },
    { id:'medical', title:'Medical Financial Assistance', key:'welfare_medical', icon:'dollar-sign', fields:[
        {k:'diaryNo',label:'Diary No.',type:'number'},
        {k:'dateReceived',label:'Date Received',type:'date'},
        {k:'applicantName',label:'Applicant Name',type:'text'},
        {k:'subject',label:'Subject',type:'text'},
        {k:'fromOffice',label:'From Office',type:'text'},
        {k:'claimAmount',label:'Claim Amount',type:'number'},
        {k:'illnessReason',label:'Illness / Reason',type:'text'},
        {k:'missing1',label:'Missing Docs Letter 1st',type:'date', optional: true},
        {k:'reminder1',label:'Reminder 1',type:'date', optional: true},
        {k:'reminder2',label:'Reminder 2',type:'date', optional: true},
        {k:'documentsReceived',label:'Documents Received',type:'date', optional: true},
        {k:'sentHigher',label:'Sent to Higher Office',type:'date', optional: true},
        {k:'status',label:'Status',type:'select',options:['Pending','Sent','Approved','Rejected','Objection']},
        {k:'remarks',label:'Remarks',type:'textarea', full:true}
    ]},
    { id:'wedding', title:'Wedding Gift', key:'welfare_wedding', icon:'gift', fields:[ /* your fields */ ] },
    { id:'scholarship', title:'Scholarships', key:'welfare_scholarship', icon:'graduation-cap', fields:[ /* your fields */ ] },
    { id:'basicpay', title:'Last Month Basic Pay', key:'welfare_basicpay', icon:'wallet', fields:[ /* your fields */ ] },
    { id:'misc', title:'Misc Letter', key:'welfare_misc', icon:'mail', fields:[ /* your fields */ ] },
    { id:'wmc', title:'Welfare Management Committee (WMC)', icon:'users', subSections:[
        { id:'wmc_medical', title:'Medical Financial Assistance', key:'welfare_wmc_medical', icon:'dollar-sign', fields:[ /* your fields */ ] },
        { id:'wmc_financial', title:'Financial Assistance', key:'welfare_wmc_financial', icon:'wallet', fields:[ /* your fields */ ] },
        { id:'wmc_other', title:'Other', key:'welfare_wmc_other', icon:'file-text', fields:[ /* your fields */ ] },
        { id:'wmc_funds', title:'Add Funds', key:'welfare_wmc_funds', icon:'dollar-sign', fields:[ /* your fields */ ] }
    ]},
    { id:'settings', title:'Settings', icon:'settings' }
];

// ... baqi sab functions tumhare code ke mutabiq hain (full code hai, koi cheez miss nahi)

function renderDashboard() {
    const leafSections = SECTIONS.filter(s => s.key);
    const data = calculateDashboardData(leafSections);
    contentArea.innerHTML = `
        <h2 class="text-3xl font-bold mb-6 text-[var(--text-primary)]">Welfare Status Dashboard</h2>
        <div class="overflow-x-auto -mx-4 px-4">
            <div id="dashboardContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                ${leafSections.map(sec => {
                    const d = data[sec.id] || {pending:0,sent:0,completed:0,approvedRejected:0};
                    return `
                    <div class="bg-[var(--card-bg)] rounded-xl shadow-lg border border-[var(--border-color)] overflow-hidden">
                        <div class="p-4 bg-[#222222] border-b border-[var(--border-color)] cursor-pointer dashboard-card" onclick="setActiveTab('${sec.id}')">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="text-xl font-semibold text-[var(--text-primary)]">${sec.title}</h3>
                                    <p class="text-sm text-[var(--text-secondary)] mt-1">View and manage entries</p>
                                </div>
                                <i data-lucide="${sec.icon}" class="w-8 h-8 text-[var(--primary-color)] opacity-70"></i>
                            </div>
                        </div>
                        <div class="p-4 grid grid-cols-2 gap-3 text-center">
                            <div class="bg-[#222222] rounded-lg p-3"><div class="text-2xl font-bold text-yellow-400">${d.pending}</div><div class="text-xs text-[var(--text-secondary)]">Pending</div></div>
                            <div class="bg-[#222222] rounded-lg p-3"><div class="text-2xl font-bold text-blue-400">${d.sent}</div><div class="text-xs text-[var(--text-secondary)]">Sent</div></div>
                            <div class="bg-[#222222] rounded-lg p-3"><div class="text-2xl font-bold text-green-400">${d.completed}</div><div class="text-xs text-[var(--text-secondary)]">Completed</div></div>
                            <div class="bg-[#222222] rounded-lg p-3"><div class="text-2xl font-bold text-red-400">${d.approvedRejected}</div><div class="text-xs text-[var(--text-secondary)]">Final</div></div>
                        </div>
                    </div>`;
                }).join('')}
            </div>
        </div>
    `;
    initializeIcons();
}

window.onload = async function() {
    initializeIcons();
    await initAuth();
};
</script>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getFirestore, collection, getDoc, setDoc, doc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCVj-Eb9wNAaqwFyGdRgC7uyR24O2jjOIw",
    authDomain: "spuwelfarediary.firebaseapp.com",
    projectId: "spuwelfarediary",
    storageBucket: "spuwelfarediary.firebasestorage.app",
    messagingSenderId: "976541344867",
    appId: "1:976541344867:web:96f6e70b42f0ab33808456"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  window.db = db; window.auth = auth;
</script>
</body>
</html>
